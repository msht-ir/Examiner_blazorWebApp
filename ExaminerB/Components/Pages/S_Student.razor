@page "/S_Student"
@using ExaminerB.Service
@inject ProtectedSessionStorage sessionStorage
@inject FeService feService
@inject NavigationManager Navman
@inject AppState appState
@inject IJSRuntime JS
@implements IDisposable
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<div class="container mt-5 align-items-center">
    <p style="font-size:larger; text-align:center;color:black">e<span style="color:indianred">x</span>aminer <span style="font-size:small;color:royalblue"> @appState.UserNickname</span></p>
    <hr style="color:red"/>
    @if (!_hasFetched)
        {
        <_Loading />
        }
    else
        {
        <div class="accordion" id="accordionStudent" style="max-width:500px; margin: 0 auto;">
            @* StudentCourses *@
            <div class="accordion-item">
                    <h4 class="accordion-header">
                        <button class="accordion-button @(appState.Cmd=="ShowCourseFolders" ? "" : "collapsed")"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#CollapseId2"
                            aria-expanded="@(appState.Cmd=="ShowCourseFolders" ? "true" : "false")"
                            aria-controls="CollapseId2" style="background-color:WhiteSmoke">
                            <h4>Courses <span style="font-weight:bold;font-size:x-small;color:forestgreen">( @lstStudentCourses.Count )</span></h4>
                        </button>
                    </h4>
                    <div id="CollapseId2" class="accordion-collapse collapse @(appState.Cmd=="ShowCourseFolders" ? "show" : "")" data-bs-parent="#accordionStudent">
                        <div class="accordion-body" style="background-color:white">
                            <div id="T2">
                                @foreach (StudentCourse studentCourse in lstStudentCourses)
                                    {
                                    <MudContainer Class="mt-2 px-0">
                                        <MudCard Class="mx-0">
                                            <MudCardContent Style="background-color: rgba(250,250,2250);">
                                                @* use (double) to make result decimal not integer *@
                                                @{strRunningPoint = studentCourse.NumberOfTests == 0 ?"---": $"{studentCourse.CorrectAnswers} / {studentCourse.NumberOfTests} = {((double)studentCourse.CorrectAnswers / studentCourse.NumberOfTests * 20.0):F2}";}
                                                <div style="color:black;font-weight:bold;">@studentCourse.CourseName : <span style="font-size:small;font-weight:bold;color:indianred">@strRunningPoint</span></div>
                                                <button class="btn btn-link" @onclick="()=>BtnTakeATest (studentCourse.StudentCourseId)">
                                                    <img src="/img/gifChart2.gif" width="30" />
                                                </button>
                                                @if ((studentCourse.StudentCourseTags & 5) == 5)
                                                    {
                                                    <button class="btn btn-link" @onclick="()=>BtnReportStudentCourseTests(studentCourse.StudentCourseId, studentCourse.CourseName)">
                                                        <img src="/img/icoReport1.png" width="20" />
                                                    </button>
                                                    }
                                                @if ((studentCourse.StudentCourseTags & 3) == 3)
                                                    {
                                                    <button class="btn btn-link" @onclick="()=>BtnTryToCorrect(studentCourse.StudentCourseId)">
                                                        <img src="/img/icoRedo.png" width="22" />
                                                    </button>
                                                    }
                                                @if ((studentCourse.StudentCourseTags & 3) == 3)
                                                    {
                                                    <button class="btn btn-link" @onclick='async ()=> await BtnFilterStudentCourseTests(studentCourse , "filter")'>
                                                        <img src="/img/icoFilter.png" width="22" />
                                                    </button>
                                                    <button class="btn btn-link" style="border: none;" @onclick='async ()=> await BtnFilterStudentCourseTests(studentCourse, "wipeout")'>
                                                        <img src="/img/icoEraser.png" width="22" />
                                                    </button>
                                                    }
                                                @* CourseFolders *@
                                                @if((appState.Cmd=="ShowCourseFolders") & (studentCourse.CourseId == appState.CourseId))
                                                    {
                                                    <h6 style="padding-left:10px;">folders: </h6>
                                                    foreach(CourseFolder cf in lstCourseFolders)
                                                        {
                                                        <h6 style="padding-left:10px;"><a href="@cf.CourseFolderUrl" target="_blank">@cf.CourseFolderTitle</a></h6>
                                                        }
                                                    }
                                                else
                                                    {
                                                    <button class="btn btn-link" style="border: none;" @onclick='async ()=> await BtnShowCourseFolders(studentCourse)'>
                                                        <img src="/img/icoFolderCF.png" width="25" />
                                                    </button>
                                                    }
                                            </MudCardContent>
                                        </MudCard>
                                    </MudContainer>
                                    }
                            </div>
                        </div>
                    </div>
                </div>
            <br />
            @* StudentExams *@
            <div class="accordion-item">
                    <h4 class="accordion-header">
                        <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#CollapseId1"
                            aria-expanded="false"
                            aria-controls="CollapseId1" style="background-color:whitesmoke">
                            <h4>Exams <span style="font-weight:bold;font-size:x-small;color:forestgreen">( @lstStudentExams.Count )</span></h4>
                        </button>
                    </h4>
                    <div id="CollapseId1" class="accordion-collapse collapse" data-bs-parent="#accordionStudent">
                        <div class="accordion-body" style="background-color:white">
                            <div id="T1">
                                <table class="table table-borderless">
                                    @foreach (StudentExam studentExam in lstStudentExams)
                                    {
                                        <MudContainer Class="mt-2 px-0">
                                            <MudCard Class="mx-0">
                                                <MudCardContent Style="background-color:whitesmoke;">
                                                    <MudGrid>
                                                        <!-- Left column -->
                                                        <MudItem xs="6">
                                                            @* SE_Tags 1:active 2:started 4:finished 8:review? *@
                                                            @if ((studentExam.StudentExamTags & 7) > 1)
                                                                {
                                                                <div style="color:indianred; font-weight:bold;">
                                                                    <div><span style="color:gray; font-weight:normal;">@studentExam.CourseName</span></div>
                                                                    <div>@studentExam.ExamTitle</div>
                                                                    <div><span style="color:black; font-weight:normal;">@studentExam.ExamDateTime</span></div>
                                                                </div>
                                                                }
                                                            @if ((studentExam.StudentExamTags & 7) == 1)
                                                                {
                                                                <div style="color:darkslategrey; font-weight:bold;">
                                                                    <div><span style="color:gray; font-weight:normal;">@studentExam.CourseName</span></div>
                                                                    <div>@studentExam.ExamTitle</div>
                                                                    <div><span style="color:black; font-weight:normal;">@studentExam.ExamDateTime</span></div>
                                                                </div>
                                                                }
                                                        </MudItem>
                                                        <!-- Right column -->
                                                        <MudItem xs="6">
                                                            <div>Tests: @studentExam.ExamNTests</div>
                                                            <div>Time: @studentExam.ExamDuration min</div>
                                                            @if ((studentExam.StudentExamTags & 7) == 1)
                                                                {
                                                                <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" OnClick="async () => await BtnStartExam(studentExam)" />                                                            
                                                                }
                                                            else if ((studentExam.StudentExamTags & 7) == 3)
                                                                {
                                                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="async () => await BtnStartExam(studentExam)" />
                                                                }
                                                            else if ((studentExam.StudentExamTags & 7) == 7)
                                                                {
                                                                <div>
                                                                    <span style="color:indianred;font-size:small;font-weight:bold;">
                                                                        Pnt @studentExam.StudentExamPoint.ToString("F2")/20
                                                                    </span>
                                                                </div>
                                                                }
                                                            @if ((studentExam.StudentExamTags & 9) == 9)
                                                                {
                                                                <MudIconButton Icon="@Icons.Material.Filled.Assignment" Size="Size.Small" OnClick="() => BtnReportExam(studentExam.StudentExamId)" />                                                            
                                                                }
                                                        }
                                                    </MudItem>
                                                </MudGrid>
                                            </MudCardContent>
                                        </MudCard>
                                    </MudContainer>
                                    }
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            <br />
            @* StudentMessages *@
            <div class="accordion-item">
                    <h4 class="accordion-header">
                        <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#CollapseId3"
                            aria-expanded="false"
                            aria-controls="CollapseId3" style="background-color:WhiteSmoke">
                            <h4>Messages <span style="font-weight:bold;font-size:x-small;color:indianred">( @unreadCount <span style="color:blue">/@lstStudentMessages.Count</span> )</span></h4>
                        </button>
                    </h4>
                    <div id="CollapseId3" class="accordion-collapse collapse" data-bs-parent="#accordionStudent">
                        <div class="accordion-body" style="background-color:white">
                            <div id="T3">
                                @* List messages *@
                                @foreach (StudentMessage studentMessage in lstStudentMessages)
                                    {
                                    <MudContainer Class="mt-2 px-0">
                                        <MudCard Class="mx-0">
                                            <MudCardContent Style="background-color:whitesmoke;">
                                                @if((studentMessage.StudentMessageTags & 1) == 1)
                                                    {
                                                    <div style="color:black;font-weight:normal;padding-left:10px; text-align:center">
                                                        @studentMessage.MessageTitle
                                                        <div style="font-size:smaller; font-weight:bold;color:indianred">
                                                            @studentMessage.DateTimeSent
                                                        </div>
                                                    </div>
                                                    <hr style="color:gray" />
                                                    <div style="color:black;font-weight:normal;padding-left:10px;">@studentMessage.MessageBody</div>
                                                        <hr style="color:gray" />
                                                        <div style="text-align:center">
                                                            <button class="btn btn-link" @onclick="()=>BtnDeleteStudentMessage(studentMessage)">
                                                                <img src="/img/icoDelete1.png" width="20" />
                                                            </button>
                                                            @* IsBookmarked *@
                                                            @if ((studentMessage.StudentMessageTags & 2) == 2)
                                                                {
                                                                <button class="btn btn-link" @onclick="()=>BtnSetStudentMessageBookmark(studentMessage, 0)">
                                                                    <img src="/img/icoBookmark1.png" width="22" />
                                                                </button>
                                                                }
                                                            else
                                                                {
                                                                <button class="btn btn-link" @onclick="()=>BtnSetStudentMessageBookmark(studentMessage, 1)">
                                                                    <img src="/img/icoBookmark0.png" width="22" />
                                                                </button>                                    
                                                                }
                                                            @* TypeIsFeedback *@
                                                            @if ((studentMessage.StudentMessageTags & 8) == 8)
                                                                {
                                                                @* AnswerIsYes/No *@
                                                                @if ((studentMessage.StudentMessageTags & 16) == 16)
                                                                    {
                                                                    <button class="btn btn-link" @onclick="()=>BtnSetMyAnswer(studentMessage, 2)">
                                                                        <img src="/img/icoYesNo_Yes.png" width="20" />
                                                                    </button>
                                                                    }
                                                                else if ((studentMessage.StudentMessageTags & 32) == 32)
                                                                    {
                                                                    <button class="btn btn-link" @onclick="()=>BtnSetMyAnswer(studentMessage, 2)">
                                                                        <img src="/img/icoYesNo_No.png" width="20" />
                                                                    </button>
                                                                    }
                                                                else
                                                                    {
                                                                    if ((appState.Cmd == "GetStudentAnswer") & (appState.MessageId == studentMessage.MessageId))
                                                                        {
                                                                        <button class="btn btn-link" @onclick="()=>BtnSetMyAnswer(studentMessage, 1)">
                                                                            <img src="/img/icoYesNo_Yes.png" width="20" />
                                                                        </button>
                                                                        <button class="btn btn-link" @onclick="()=>BtnSetMyAnswer(studentMessage, 0)">
                                                                            <img src="/img/icoYesNo_No.png" width="20" />
                                                                        </button>                                                
                                                                        }
                                                                    else
                                                                        {
                                                                        //Lets GetStudentAnswer...
                                                                        <button class="btn btn-link" @onclick="()=>BtnGetStudentAnswer(studentMessage.MessageId)">
                                                                            <img src="/img/icoYesNo.png" width="24" />
                                                                        </button>
                                                                        }
                                                                    }
                                                                }
                                                        </div>
                                                        }
                                                    else
                                                        {
                                                        <span style="padding-left:5px; color:indianred"> @studentMessage.DateTimeSent </span>
                                                        <button class="btn btn-link" @onclick="()=>BtnSetStudentMessageAsRead(studentMessage)">
                                                            <img src="/img/icoEnvelop2.png" width="20" />
                                                        </button>
                                                        <span style="color:black;font-weight:bold;padding-left:2px;">@studentMessage.MessageTitle.Substring(0,6) ...</span>
                                                        }
                                            </MudCardContent>
                                        </MudCard>
                                    </MudContainer>
                                    }
                            </div>
                        </div>
                    </div>
                </div>
        </div>
        <br />
        <div style="text-align:center">
            <button class="btn btn-link" @onclick= "()=> BtnExit()">
                <img src="/img/gifUserLogout.gif" style="width:125px; height:80px" />
            </button>
        </div>
        }
</div>
<script>
    window.scrollToTop = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }; 
</script>

@code {
    User student = new User ();
    public List<StudentCourse> lstStudentCourses = new List<StudentCourse>();
    public List<CourseFolder> lstCourseFolders = new List<CourseFolder> ();
    public List<StudentExam> lstStudentExams = new List<StudentExam>();
    public List<StudentMessage> lstStudentMessages = new List<StudentMessage> ();
    public string? strRunningPoint = "";
    private bool _hasFetched = false;
    private bool hasScrolled = false;
    private int unreadCount = 0;

    //LifeCycleEvents
    protected override async Task OnInitializedAsync()
    {
        appState.OnChange += TriggerRender;
        if(Convert.ToInt32(appState.UserLoginStatus) != 1)
        {
            Navman.NavigateTo ("/Login");
        }
        student.UserId = appState.UserId ?? 0;
        if(student.UserId > 0)
        {
            //on first run, student.UserId is 0
            //student.UserId = appState.UserId ?? 0;
            lstStudentExams = await feService.Read_StudentExams(student.UserId, "ByStudentId")?? new List<StudentExam>();
            student.UserTags = Convert.ToInt32(appState.UserTags);
            student.UserName = appState.UserName ?? "";
            student.UserNickname = appState.UserNickname ?? "";
            lstStudentCourses = await feService.Read_StudentCourses (student.UserId, "ByStudentId");
            await ReadMessageList ();
            _hasFetched = true;
            }
        }
    protected override async Task OnAfterRenderAsync(bool firstRender)
        {
        if (firstRender && !hasScrolled)
            {
            hasScrolled = true;
            await JS.InvokeVoidAsync("scrollToTop");
            }
        }
    private void TriggerRender()
        {
        InvokeAsync(StateHasChanged);
        }
    public void Dispose()
        {
        appState.OnChange -= TriggerRender;
        }    
    //btns for StudentExams
    public async Task BtnStartExam(StudentExam studentExam)
        {
        //read ExamTags : is exam training? Yes:allow Help
        Exam exam = await feService.Read_Exam (studentExam.ExamId, false);
        //keep ExamTags in appState (use in S-StudentExamTest page)
        appState.SetExamTags (exam.ExamTags);
        bool result = await feService.Update_StudentExamTags(studentExam, "startedOn");
        if (result)
            {
            appState.SetStudentExamId (studentExam.StudentExamId);
            Navman.NavigateTo ($"/S_StudentExamTests");
            }
        }
    private void BtnReportExam(int studentExamId)
        {
        Navman.NavigateTo ($"/S_ReportStudentExam/{studentExamId}/Review");
        }    
    //btns under the table
    private void BtnExit()
        {
        Navman.NavigateTo("/Login", true);
        }
    //btns for StudentCourses
    private void BtnTakeATest (int studentCourseId)
        {
        Navman.NavigateTo ($"S_StudentCourseTest/{student.UserId}/{studentCourseId}/new");
        }
    private void BtnTryToCorrect (int studentCourseId)
        {     
        Navman.NavigateTo ($"S_StudentCourseTest/{student.UserId}/{studentCourseId}/edit");
        }
    private async Task BtnShowCourseFolders (StudentCourse studentCourse)
        {
        _hasFetched = false;
        appState.SetCmd ("ShowCourseFolders");
        appState.SetCourseId (studentCourse.CourseId);
        lstCourseFolders = await feService.Read_CourseFolders (studentCourse.CourseId);
        _hasFetched = true;
        }
    private void BtnReportStudentCourseTests (int studentCourseId, string courseName)
        {
        Navman.NavigateTo ($"/S_ReportStudentCourse/{student.UserId}/{studentCourseId}/{courseName}");
        }
    private async Task BtnFilterStudentCourseTests (StudentCourse studentCourse, string mode)
        {
        //this code replaced by lambda equivalent
        // switch (mode)
        //     case "filter":{message = $"Filter out correct answers in Course ( {studentCourse.CourseName} ) \n just keep incorrect ones?";break;}
        //     case "wipeout":{message = $"Clear Running Tests in Course ( {studentCourse.CourseName} ) ?";break;}
        //---lambda:
        string msg = mode switch
            {
                "filter" => $"Filter out your correct answers in ( {studentCourse.CourseName} ) ?",
                "wipeout" => $"Clear all your sample tests in ( {studentCourse.CourseName} ) ?",
                _ => throw new ArgumentException($"Invalid mode: {mode}")
                };
        
        var message = new MarkupString($"{msg}");
        bool? confirmResult = await DialogService.ShowMessageBox(
            title: "Confirm Clear your data",
            markupMessage: message,
            yesText: "Yes",
            cancelText: "No");
        if (confirmResult == true)
            {
            var result = await feService.Delete_StudentCourseTests (mode, studentCourse);
            //refresh
            lstStudentCourses = await feService.Read_StudentCourses (student.UserId, "ByStudentId");        
            }
        }
    //btns for StudentMessages
    private async Task BtnSetStudentMessageAsRead(StudentMessage studentMessage)
        {
        //modes: setOn, setOff
        studentMessage.StudentMessageTags |= 1;
        studentMessage.DateTimeRead = DateTime.Now.ToString("yyyy-MM-dd . HH:mm");
        bool result = await feService.Update_StudentMessageSetAsRead (studentMessage);
        await ReadMessageList ();
        StateHasChanged ();
        }
    private async Task BtnSetStudentMessageBookmark(StudentMessage studentMessage, int mode)
        {
        //modes: 0:setOff, 1:setOn
        switch (mode)
            {
            case 0:
                    {
                    studentMessage.StudentMessageTags &= ~2;
                    break;
                    }
            case 1:
                    {
                    studentMessage.StudentMessageTags |= 2;
                    break;
                    }
            }
        bool result = await feService.Update_StudentMessageTags (studentMessage);
        await ReadMessageList ();
        appState.SetCmd ("");
        StateHasChanged ();
        }
    private async Task BtnSetMyAnswer(StudentMessage studentMessage, int ans)
        {
        //ans: 0:No, 1:Yes
        switch (ans)
            {
            case 2:
                    {
                    studentMessage.StudentMessageTags &= ~16;
                    studentMessage.StudentMessageTags &= ~32;
                    appState.SetCmd ("");
                    break;
                    }
            case 1:
                    {
                    studentMessage.StudentMessageTags |= 16;
                    studentMessage.StudentMessageTags &= ~32;
                    break;
                    }
            case 0:
                    {
                    studentMessage.StudentMessageTags &= ~16;
                    studentMessage.StudentMessageTags |= 32;
                    break;
                    }
            }
        bool result = await feService.Update_StudentMessageTags (studentMessage);
        await ReadMessageList ();
        StateHasChanged ();
        }
    private async Task BtnGetStudentAnswer(int messageId)
        {
        //Lets GetStudentAnswer...
        appState.SetCmd ("GetStudentAnswer");
        appState.SetMessageId (messageId);
        StateHasChanged ();
        }
    private async Task BtnDeleteStudentMessage(StudentMessage studentMessage)
        {
        var message = new MarkupString($"Delete Message?");
        bool? confirmResult = await DialogService.ShowMessageBox(title: "Confirm", markupMessage: message, yesText: "Yes", cancelText: "No");
        if (confirmResult == true)
            {
            studentMessage.StudentMessageTags |= 4;
            bool result = await feService.Update_StudentMessageTags (studentMessage);
            Snackbar.Add("Deleted", Severity.Info); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
            await ReadMessageList ();
            }
        StateHasChanged ();                
        }
    //methods
    private async Task ReadMessageList()
        {
        lstStudentMessages = await feService.Read_StudentMessages (student.UserId, "ByStudentIdIgnoreDeletedMessages");        
        //first bit: 0 = unread, 1 = read
        unreadCount = lstStudentMessages.Count(m => (m.StudentMessageTags & (1 << 1)) == 0);
        }
}
