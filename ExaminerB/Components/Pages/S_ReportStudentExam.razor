@page "/S_ReportStudentExam/{studentExamId:int}/{pagemode}"
@using ExaminerB.Service
@rendermode InteractiveServer
@inject NavigationManager Navman
@inject AppState appState
@inject FeService feService
@inject IJSRuntime JS
@implements IDisposable

@if (_hasFetched != true)
    {
    <_ScanSheets />
    }
else
    {
    <EditForm Model="studentExam">
        <div style="text-align: center;">
            <h4>@studentExam.ExamTitle <span style="font-size:small;color:royalblue;"> - @student.UserName</span></h4>
            <h6>Course: @studentExam.CourseName - code: @studentExam.StudentExamId </h6>
        </div>
        <hr />
        @foreach (StudentExamTest studentExamTest in studentExam.StudentExamTests)
            {
            i++;
            tstRTLcss = ((studentExamTest.TestTags & 1) == 1) ? "direction:rtl;text-align:right;" : "";
            optRTLcss = ((studentExamTest.TestTags & 2) == 2) ? "direction:rtl;text-align:right;" : "";
            @if (((studentExamTest.StudentExamTestTags & 8) == 8) && (pagemode == "Review"))
                {
                <div style="@tstRTLcss"><span style="font-weight:bold;color:lightcoral;">@i:[H] </span>@studentExamTest.TestTitle</div>
                }
            else
                {
                <div style="@tstRTLcss"><span style="font-weight:bold;">@i: </span>@studentExamTest.TestTitle</div>
                }
            @foreach (TestOption opt in studentExamTest.TestOptions)
                {
                int optcolor = 0;
                if (pagemode == "RawSheet")
                    {
                    optcolor = 0;
                    }
                else
                    {
                    if (opt.TestOptionId == studentExamTest.StudentExamTestKey)
                        {
                        optcolor = optcolor | 1;
                        }
                    if (opt.TestOptionId == studentExamTest.StudentExamTestAns)
                        {
                        optcolor = optcolor | 2;
                        }                    
                    }
                switch (optcolor)
                    {
                    case 0:
                            {
                            <div style="@optRTLcss color:black"> - @opt.TestOptionTitle</div>
                            break;
                            }
                    case 1:
                            {
                            <div style="@optRTLcss color:blue"> ( ) @opt.TestOptionTitle</div>
                            break;
                            }
                    case 2:
                            {
                            <div style="@optRTLcss color:red"> (x) @opt.TestOptionTitle</div>
                            break;
                            }
                    case 3:
                            {
                            <div style="@optRTLcss color:goldenrod;"> - @opt.TestOptionTitle</div>
                            break;
                            }
                    }
                }
            <hr style="border-color:red" />
            }
    </EditForm>
    <div style="text-align:center">
        <button class="btn btn-link" @onclick= "()=> BtnBackToStudentExams()">
            <img src="/icons/icoBack_bt_1.png" style="width:40px" />
        </button>   
    </div>
    }

@code {
    [Parameter] public int studentExamId { get; set; }
    [Parameter] public string pagemode { get; set; } = ""; // possible values: {Review|RawSheet}
    User student = new User ();
    StudentExam studentExam = new StudentExam ();
    StudentExamTest studentExamTest = new ();
    string tstRTLcss="";
    string optRTLcss="";
    int i = 0;
    bool _hasFetched = false;
    //LifeCycleEvents
    protected override async Task OnInitializedAsync()
        {
        appState.OnChange += TriggerRender;
        }
    protected override async Task OnParametersSetAsync()
        {      
        }
    protected override async Task OnAfterRenderAsync(bool firstRender)
        {
        //scroll to top
        if (firstRender)
            {
            await JS.InvokeVoidAsync("window.scrollTo", 0, 0);
            }
        if (!_hasFetched)
            {
            student.UserName = appState.UserName ?? "";
            studentExam.StudentExamId = studentExamId;
            studentExam = await feService.Read_StudentExam (studentExamId);
            _hasFetched = true;
            StateHasChanged ();
            }
        }
    private void TriggerRender()
        {
        InvokeAsync(StateHasChanged);
        }
    public void Dispose()
        {
        appState.OnChange -= TriggerRender;
        }    
    //btns
    public void BtnBackToStudentExams ()
        {
        Navman.NavigateTo ("/S_Student");
        }
    //methods
    }
