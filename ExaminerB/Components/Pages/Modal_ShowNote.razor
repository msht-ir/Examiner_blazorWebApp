@inject AppState appState;
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject FeService feService

@if (IsOpen)
{
    noteDatum = appState.NoteDatum;
    noteText = appState.NoteText;
    Title = "notes";
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">
                        <span style="text-align:center;color:royalblue; font-weight:normal;">@appState.NoteParentName</span>
                        <br />
                        <span style="text-align:center; color:indianred; font-weight:normal;">@noteDatum</span>
                    </h6>
                </div>
                <div class="modal-body">
                        @if(Convert.ToBoolean(appState.NoteIsRtl))
                        {
                        <div class="mt-3 text-end">
                            <MudContainer Class="mt-2 px-0">
                                <MudCard Class="mx-0">
                                    <MudCardContent Style="background-color:whitesmoke;">
                                        <div style='font-weight:normal; font-size:small; white-space: pre-wrap; font-family:"Segoe UI"; font-size:@(_cmd == "UseLargeFontSize" ? "large" : "small")'>
                                            @noteText
                                        </div>
                                    </MudCardContent>
                                </MudCard>
                            </MudContainer>
                        </div>
                        }

                    else
                        {
                        <div class="mt-3">
                                <MudContainer Class="mt-2 px-0">
                                    <MudCard Class="mx-0">
                                        <MudCardContent Style="background-color:whitesmoke;">
                                            <div style='font-weight:bold; white-space: pre-wrap; font-family:"Courier New", Courier, monospace;font-size:@(_cmd == "UseLargeFontSize" ? "regular" : "smaller")'>
                                                @noteText
                                            </div>
                                        </MudCardContent>
                                    </MudCard>
                                </MudContainer>
                        </div>                        
                        }
                    <br />
                    <div style="text-align:center">
                        <button class="btn btn-link" @onclick="BtnEditNote">
                            <img src="/img/icoRename.png" title="edit this note ويرايش" alt="FontSize" width="34"/>
                        </button>
                        <button class="btn btn-link" @onclick="BtnChangeFontSize">
                            <img src="/img/icoFontAa.png" title="Font Size  تغيير انداز فونت" alt="FontSize" width="32"/>
                        </button>
                        <button class="btn btn-link" @onclick="BtnDeleteNote">
                            <img src="/img/icoDelete1.png" width="24" title="delete note"/>
                        </button>
                    </div>
                    <div style="text-align:center">
                        <hr />
                        <button class="btn btn-link" @onclick="Close">
                            <img src="/img/icoCancel.png" width="24" title="close / back"/>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string Title { get; set; }
    [Parameter] public RenderFragment ChildContent { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    string _cmd = "";
    public bool IsOpen { get; set; } = true;
    string noteDatum = "";
    string noteText = "";
    bool needEdit = false;
    public void Open() => IsOpen = true;
    private async Task Close()
        {
        if (OnClose.HasDelegate)
            {
            if (!needEdit)
                {
                appState.SetCmd("");
                }
            await OnClose.InvokeAsync();
            }
        IsOpen = false;
        }
    private async Task BtnChangeFontSize()
        {
        _cmd = (_cmd == "UseLargeFontSize") ? "": "UseLargeFontSize";
        StateHasChanged ();
        }
    public async Task BtnEditNote()
        {
        // var message = new MarkupString($"<hr><span style='color:RoyalBlue'>Edit</span> this note?<br><br> <div style='text-align:center'><img src='/img/icoRename.png' width='55'/></div><br><hr>");
        // bool? confirmResult = await DialogService.ShowMessageBox(title: "Confirm", markupMessage: message, yesText: "Yes", cancelText: "No");
        // if (confirmResult == true)
        //     {
            int noteId = Convert.ToInt32(appState.SelectedNoteId);
            needEdit = true;
            //force page T_ReportNotes call Modal_CreateNote to edit/update this note            
            appState.SetCmd ("UpdateNote");
            await Close ();
        //     }
        }
    public async Task BtnDeleteNote()
        {
        var message = new MarkupString($"<hr><span style='color:indianred'>Delete</span> note? Are you sure?<br><br> <div style='text-align:center'><img src='/img/icoDelete1.png' width='40'/></div><br><hr>");
        bool? confirmResult = await DialogService.ShowMessageBox(title: "Confirm", markupMessage: message, yesText: "Yes", cancelText: "No");
        if (confirmResult == true)
            {
            int noteId = Convert.ToInt32(appState.SelectedNoteId);
            bool result = await feService.Delete_Note (noteId);
            if(result)
                {
                Snackbar.Add($"deleted", Severity.Warning); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                Close ();
                }
            else
                {
                Snackbar.Add($"Failed to delete note!", Severity.Error); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                }
            }
        }

}
