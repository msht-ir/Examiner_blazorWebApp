@page "/T_Exams"
@using ExaminerB.Service
@using Microsoft.VisualBasic
@inject FeService feService
@rendermode InteractiveServer
@inject NavigationManager Navman
@inject AppState appState
@inject IJSRuntime JS
@implements IDisposable

<div style="text-align: center;">
    <h2 style="color:gray">e<span style="color:indianred">x</span>aminer<span style="font-style:italic;font-size:small;color:royalblue"> WebApp </span> <span style="font-style:italic;font-size:small;color:indianred"> - @appState.UserRole </span></h2>
    <h5 class="card-title text-center text-secondary">@course.CourseName - exams</h5>
    @if (appState.Message != "")
        {
        <h6 style="color:indianred">@appState.Message</h6>
        }
</div>
<div class="container mt-5">
    <div class="card">
        <div class="card-body">
            <EditForm Model="lstCourseExams">
                <table class="table">
                    <thead>
                        <tr style="font-weight:bold; border:none">
                            <td>Exam</td>
                            <td>Info</td>
                        </tr>
                    </thead>
                    @foreach (var exam in lstCourseExams)
                        {
                        <tr style="align-content:center; border:none">
                            <td style="color:indianred; font-weight:bold;">
                                @exam.ExamTitle <br />
                                <span style="color:black; font-weight:normal;">@exam.ExamDateTime</span><br />
                                    @{
                                    int examId = exam.ExamId;
                                    }
                                <button style="border:none" class="btn btn-link" @onclick="()=>BtnEditExam(exam)" >
                                    <img src="/icons/icoRename_bt_1.png" width="35" />
                                </button>
                                <button style="border:none" class="btn btn-link" @onclick="BtnAddStudentExam" >
                                    <img src="/icons/icoUserAdd_bluet_1.png" width="30" />
                                </button>
                                <button style="border:none" class="btn btn-link" @onclick="BtnReportStudentsOfThisExam" >
                                    <img src="/icons/icoGroup_grayt_1.png" width="30" />
                                </button>
                                <button style="border:none" class="btn btn-link" @onclick="BtnReportExamTests">
                                    <img src="/icons/icoReport_bt_1.png" width="25" />
                                </button>
                                <button style="border:none" class="btn btn-link" @onclick="()=>BtnDeleteExam(exam.ExamId)" >
                                    <img src="/icons/icoDelete_bt_1.png" width="25" />
                                </button>
                                <br />
                                <br />
                                @if (appState.Cmd == "AddStudentToExam" && (@examId == appState.ExamId))
                                    {
                                    //GetStudentList ();
                                    <hr />
                                    <div style="color:darkgoldenrod;font-weight:bold;">
                                        Add Students to Exam:
                                    </div>
                                    <div>
                                        <select id="cboStudents1" name="cboStudents1" style="width:75%">
                                            <option value="0"> Select a Student... </option>
                                            @foreach (var stdnt in lstStudents)
                                                {
                                                <option value="@stdnt.UserId"> @stdnt.UserName </option>
                                                }
                                        </select>
                                    </div>
                                    <br />
                                    <div>
                                        <select id="cboStudents2" name="cboStudents2" style="width:75%">
                                            <option value="0"> Select a Student... </option>
                                            @foreach (var stdnt in lstStudents)
                                                {
                                                <option value="@stdnt.UserId"> @stdnt.UserName </option>
                                                }
                                        </select>
                                    </div>
                                    <br />
                                    <div>
                                        <select id="cboStudents3" name="cboStudents3" style="width:75%">
                                            <option value="0"> Select a Student... </option>
                                            @foreach (var stdnt in lstStudents)
                                                {
                                                <option value="@stdnt.UserId"> @stdnt.UserName </option>
                                                }
                                        </select>
                                    </div>
                                    <button style="border:none" class="btn btn-link" @onclick="()=>BtnCreateStudentExam (exam)">
                                        <img src="/icons/icoSave_cw_1.png" width="25" />
                                    </button>
                                    <br />
                                    <br />
                                    }
                            </td>
                            <td>
                                Tests: @exam.ExamNTests
                                <br />
                                Time: @exam.ExamDuration m 
                                <br />
                            </td>
                        </tr>
                        }
                </table>
                <hr />
                @if (appState.Cmd == "AddNewExam")
                    {
                    <span style="font-weight:bold">New Exam:</span>
                    <br />
                    <input class="form-inline" @bind="txtNewExamTitle" placeholder="Exam name" style="width:70%" />
                    <button class="btn btn-link" @onclick="BtnCreateExam" >
                        <img src="/icons/icoSave_cw_1.png" width="25" />
                    </button>
                    }
                else
                    {
                    <button class="btn btn-link" @onclick="BtnAddNewExam">
                        <img src="/icons/icoAddItem_gt_1.png" width="30" />
                    </button>
                    }
            </EditForm>
        </div>
    </div>
</div>
<div style="text-align: center;">
    <button class="btn btn-link" @onclick="BtnBack">
        <img src="/icons/icoBack_bt_1.png" width="30" />
    </button>
</div>

@code {
    User user = new User ();
    Course course = new Course ();
    List<Exam> lstCourseExams = new ();
    List<User> lstStudents = new ();
    public string txtNewExamTitle = "";
    //LifeCycleEvents
    protected override async Task OnInitializedAsync()
        {
        appState.OnChange += TriggerRender;
        course.CourseId = Convert.ToInt32(appState.CourseId);
        course.CourseName = appState.CourseName ?? "";
        lstCourseExams = await feService.Read_Exams (course.CourseId);

        } 
    private void TriggerRender()
        {
        InvokeAsync(StateHasChanged);
        }
    public void Dispose()
        {
        appState.OnChange -= TriggerRender;
        }
    //AddNew Exam
    public void BtnAddNewExam ()
        {
        appState.SetCmd ("AddNewExam");
        StateHasChanged ();
        }
    public async Task BtnCreateExam ()
        {
        Exam newExam = new Exam () { CourseId = course.CourseId, ExamTitle = txtNewExamTitle, ExamDateTime=DateTime.Now.ToString("yyyy-MM-dd . HH:mm"), ExamDuration=10 };
        int result = await feService.Create_Exam (newExam);
        if (result > 0)
            {
            appState.SetCmd ("");
            lstCourseExams = await feService.Read_Exams (course.CourseId);
            StateHasChanged ();
            }
        }
    //btns
    public void BtnEditExam (Exam exam)
        {
        Navman.NavigateTo ($"/T_Exam/{exam.ExamId}");
        }
    public void BtnAddStudentExam ()
        {
        }
    public void BtnCreateStudentExam (Exam exam)
        {
        }
    public void BtnReportStudentsOfThisExam ()
        {
        }
    public void BtnReportExamTests ()
        {
        }
    public async Task BtnDeleteExam (int examId)
        {
        if (await JS.InvokeAsync<bool>("confirm","Delete Exam?"))
            {
            bool result = await feService.Delete_Exam (examId);
            if (result)
                {
                appState.SetCmd ("");
                lstCourseExams = await feService.Read_Exams(course.CourseId);
                StateHasChanged ();
                }
            }
        }
    
    //Exit
    public void BtnBack ()
        {
        appState.SetCmd ("");
        Navman.NavigateTo ("/T_Courses");
        }
    }
