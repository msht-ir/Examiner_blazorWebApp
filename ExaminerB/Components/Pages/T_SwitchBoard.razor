@page "/T_SwitchBoard"
@inject ProtectedSessionStorage sessionStorage
@inject NavigationManager Navman
@inject AppState appState
@implements IDisposable
@inject IDialogService DialogService

<div class="container" style="max-width:500px; margin: 0 auto;">
    <div style="text-align: center;">
        <div style="text-align: center;">
            <span style="font-style:italic;font-size:small;color:royalblue">@appState.UserNickname</span>
        </div>
        <hr style="color:red" />
        <br />
        <br />
        <table class="table table-borderless" style="text-align:center;align-content:center">
            <tr>
                <td>
                    <button class="btn btn-link" @onclick="GotoGroupsStudents">
                        <img src="/img/icoSwitchBoardStudents.png" width="80" />
                    </button>
                </td>
                <td>
                    <button class="btn btn-link" @onclick="GotoCourses">
                        <img src="/img/icoSwitchBoardCourses.png" width="85" />
                    </button>
                </td>
            </tr>
            <tr>
                <td>
                    <button class="btn btn-link" @onclick="BtnCreateNote">
                        <img src="/img/icoEditPen.png" style="width:55px" />
                    </button>
                </td>
                <td>
                    <button class="btn btn-link" @onclick="GotoProjects">
                        <img src="/img/icoSwitchBoardNoteBook.png" width="90" />
                    </button>
                </td>
            </tr>
            <tr>
                <td>
                    <button class="btn btn-link" @onclick="ReportUserNotes">
                        <img src="/img/icoNoteReport.png" style="width:70px" />
                    </button>
                </td>
                <td>
                    <button class="btn btn-link" @onclick="GotoLogin">
                        <img src="/img/icoSwitchBoardExit.png" style="width:90px" />
                    </button>
                </td>
            </tr>
        </table>
        <br />
        @* <MudSlider @bind-Value="Spacing" Min="0" Max="20" Color="Color.Info" Class="mb-6"></MudSlider> *@
        @* <E_Projects /> *@
        @if (appState.Cmd == "CreateNote")
            {
            <hr style="color:red" />    
            <Modal_CreateNote />
            }
    </div>
</div>


@code 
{
    private bool _firstRender = true;
    User user = new User ();
    public int Spacing { get; set; } = 3;
    
    //LifeCycleEvents
    protected override async Task OnInitializedAsync ()
        {
        appState.OnChange += TriggerRender;
        if(Convert.ToInt32(appState.UserLoginStatus) != 1)
            {

            Navman.NavigateTo ("/Login");
            }
        } 
    protected async Task OnAfterRenderAsync()
        {
        var result1 = await sessionStorage.GetAsync<string> ("UserName");
        Console.WriteLine ("result1.Value: " + result1.Value);
        if (result1.Success)
            {
            appState.SetUserName (result1.Value);
            user.UserName = appState.UserName;
            StateHasChanged ();
            }
        if (_firstRender)
            {
            _firstRender = false;
            var result = await sessionStorage.GetAsync<int> ("UserLoginStatus");
            if (result.Success && result.Value == 1)
                {
                appState.SetUserLoginStatus (1);
                Console.WriteLine ("T_SwitchBoard: UserLoginStatus= " + appState.UserLoginStatus);
                appState.SetUserLoginStatus (result.Value);
                }
            else
                {
                Navman.NavigateTo ("/Login");
                }
            }
        }
    private void TriggerRender() 
        {
        InvokeAsync(StateHasChanged); 
        } 
    public void Dispose() 
        {
        appState.OnChange -= TriggerRender;
        }
    //methods
    public void GotoLogin()
        {
        Navman.NavigateTo ("/Login");
        }
    public void GotoGroupsStudents ()
        {
        Navman.NavigateTo ("/T_Students");
        }
    public void GotoCourses ()
        {
        Navman.NavigateTo ("/T_Courses");
        }
    public void GotoProjects ()
        {
        Navman.NavigateTo ("/E_Projects");
        }
    public async Task BtnCreateNote ()
        {
        //parentTypes 1:user(U) 2:subprojects(SP) 3:students(S) 4:groups(G) 5:courses(C) 6:exams(E)
        appState.SetNoteParentType (1);
        appState.SetNoteParentId (Convert.ToInt32(appState.UserId));
        appState.SetCmd ("CreateNote");
        StateHasChanged ();
        //After the Modal_CreateNote is closed, HandleModalClose will refresh the list
        //to handel close event, I added in the Modal_CreateNote: [Parameter] public EventCallback OnClose 
        }
    public void ReportUserNotes ()
        {
        user.UserId = Convert.ToInt32 (appState.UserId);
        appState.SetReturnPage ("T_SwitchBoard");
        Navman.NavigateTo ($"/T_ReportNotes/1/{user.UserId}");
        }
    public void GotoCreateNewUser ()
        {
        //Navman.NavigateTo ("/E_Projects");
        }
}
