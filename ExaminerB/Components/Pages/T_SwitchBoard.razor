@page "/T_SwitchBoard"
@inject ProtectedSessionStorage sessionStorage
@inject NavigationManager Navman
@inject AppState appState
@implements IDisposable
@inject IDialogService DialogService

<div class="container" style="max-width:500px; margin: 0 auto;">
    <div style="text-align: center;">
        <div style="text-align: center;">
            <h5 style="color:gray">e<span style="color:indianred">x</span>aminer<span style="font-style:italic;font-size:small;color:royalblue"> WebApp </span> <span style="font-style:italic;font-size:small;color:indianred"> - @appState.UserRole </span></h5>
        </div>
        <h4 style="color:royalblue">@appState.UserNickname</h4>
        <hr style="color:red" />
        <br />
        <br />
        <MudGrid Spacing="@Spacing" Justify="Justify.Center">
            <MudItem>
                <MudPaper Elevation="1" Height="100px" Width="120px">
                    <button class="btn btn-link" @onclick="ReportUserNotes">
                        <img src="/img/icoNoteReport.png" style="width:80px" />
                    </button>
                </MudPaper>
            </MudItem>
            <MudItem>
                <MudPaper Elevation="1" Height="100px" Width="120px">
                    <button class="btn btn-link" @onclick="GotoProjects">
                        <img src="/img/gifNotebook.gif" width="90" />
                    </button>
                </MudPaper>
            </MudItem>
            <MudItem>
                <MudPaper Elevation="1" Height="100px" Width="120px">
                    <button class="btn btn-link" @onclick="GotoCourses">
                        <img src="/img/gifBooks.gif" width="85" />
                    </button>
                </MudPaper>
            </MudItem>
            <MudItem>
                <MudPaper Elevation="1" Height="100px" Width="120px">
                    <button class="btn btn-link" @onclick="GotoGroupsStudents">
                        <img src="/img/gifGroup1.gif" width="80" />
                    </button>
                </MudPaper>
            </MudItem>
            <MudItem>
                <MudPaper Elevation="1" Height="100px" Width="120px">
                    <button class="btn btn-link" @onclick="GotoCreateNewUser">
                        <img src="/img/icoUserTeacher.png" width="70" />
                    </button>
                </MudPaper>
            </MudItem>
            <MudItem>
                <MudPaper Elevation="1" Height="100px" Width="120px">
                    <button class="btn btn-link" @onclick="GotoLogin">
                        <img src="/img/gifExit.gif" style="width:90px" />
                    </button>
                </MudPaper>
            </MudItem>
        </MudGrid>
        <br />
        <br />
        <br />
        <br />
        @* <MudSlider @bind-Value="Spacing" Min="0" Max="20" Color="Color.Info" Class="mb-6"></MudSlider> *@
        @* <E_Projects /> *@
        @if (appState.Cmd == "CreateNote")
            {
            <hr style="color:red" />    
            <Modal_CreateNote />
            }
    </div>
</div>


@code 
{
    private bool _firstRender = true;
    User user = new User ();
    public int Spacing { get; set; } = 6;
    
    //LifeCycleEvents
    protected override async Task OnInitializedAsync ()
        {
        appState.OnChange += TriggerRender;
        if(Convert.ToInt32(appState.UserLoginStatus) != 1)
            {

            Navman.NavigateTo ("/Login");
            }
        } 
    protected async Task OnAfterRenderAsync()
        {
        var result1 = await sessionStorage.GetAsync<string> ("UserName");
        Console.WriteLine ("result1.Value: " + result1.Value);
        if (result1.Success)
            {
            appState.SetUserName (result1.Value);
            user.UserName = appState.UserName;
            StateHasChanged ();
            }
        if (_firstRender)
            {
            _firstRender = false;
            var result = await sessionStorage.GetAsync<int> ("UserLoginStatus");
            if (result.Success && result.Value == 1)
                {
                appState.SetUserLoginStatus (1);
                Console.WriteLine ("T_SwitchBoard: UserLoginStatus= " + appState.UserLoginStatus);
                appState.SetUserLoginStatus (result.Value);
                }
            else
                {
                Navman.NavigateTo ("/Login");
                }
            }
        }
    private void TriggerRender() 
        {
        InvokeAsync(StateHasChanged); 
        } 
    public void Dispose() 
        {
        appState.OnChange -= TriggerRender;
        }
    //btns
    //methods
    public void GotoLogin()
        {
        Navman.NavigateTo ("/Login");
        }
    public void GotoGroupsStudents ()
        {
        Navman.NavigateTo ("/T_Students");
        }
    public void GotoCourses ()
        {
        Navman.NavigateTo ("/T_Courses");
        }
    public void GotoProjects ()
        {
        Navman.NavigateTo ("/E_Projects");
        }
    public async Task CreateNote ()
        {
        //parentTypes 1:user(U) 2:subprojects(SP) 3:students(S) 4:groups(G) 5:courses(C) 6:exams(E)
        appState.SetNoteParentId (Convert.ToInt32(appState.UserId));
        appState.SetNoteParentType (1);
        appState.SetCmd ("CreateNote");
        StateHasChanged();
        }
    public void ReportUserNotes ()
        {
        user.UserId = Convert.ToInt32 (appState.UserId);
        appState.SetReturnPage ("T_SwitchBoard");
        Navman.NavigateTo ($"/T_ReportNotes/1/{user.UserId}");
        }
    public void GotoCreateNewUser ()
        {
        //Navman.NavigateTo ("/E_Projects");
        }
}
