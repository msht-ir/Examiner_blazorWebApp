@page "/T_ReportTests"
@using ExaminerB.Service
@using Microsoft.VisualBasic
@inject FeService feService
@inject NavigationManager Navman
@inject AppState appState
@inject IJSRuntime JS
@implements IDisposable

@if (!_hasFetched)
    {
    <_ScanSheets />
    }
else
    {
    <EditForm Model = "lstxTests">
        <br />
        <div style="text-align: center;">
            @if (appState.Cmd.ToLower().Contains("coursetest"))
                {
                @* Paginate *@
                <input class="form-control d-inline" type="number" @ref="txtPageNumber" @bind="intPendingPageNumber" min="1" placeholder="1" style="width: 70px; display: inline-block;"/>
                <button class="btn btn-link" @onclick="async ()=> await BtnReadTestsPaginated(intPendingPageNumber)">
                    <img src="/icons/icoList_bt_1.png" width="30" />
                </button>
                }
            <button class="btn btn-link" @onclick="BtnChangeFontSize">
                <img src="icons/icoFont_rt_1.png" title="Edit Test" alt="Edit" width="35px"/>
                @* <br />Font *@
            </button>
            <button class="btn btn-link" @onclick="BtnShowAnswers">
                <img src="icons/icoKeys_bt_1.png" title="Edit Test" alt="Edit" width="30px"/>
                @* <br />Keys *@
            </button>
            @if (!appState.Cmd.ToLower().Contains("coursetest"))
                {
                <button class="btn btn-link" @onclick="BtnCourseExamStats">
                    <img src="icons/icoPie_bt_1.png" title="Edit Test" alt="Edit" width="35px"/>
                    @* <br />Stats *@
                </button>
                }
            <button class="btn btn-link" @onclick="BtnBack">
                <img src="icons/icoBack_bt_1.png" title="Edit Test" alt="Edit" width="30px"/>
                @* <br />Back *@
            </button>
            <hr />
        </div>
        @{i= (intPageNumber - 1) * 20;}
        @foreach (var tst in lstxTests) 
            {
            stl= (_cmd == "useSmallFont") ? "font-size:small;" : "font-size:normal;";
            i++;
            string testRtlStatus = ((tst.TestTags & 1) == 1) ? "direction:rtl;text-align:right;" : "";
            string optRtlStatus = ((tst.TestTags & 2) == 2) ? "direction:rtl;text-align:right;" : "";
            @* Show-Test *@
            <div style="@testRtlStatus" >
                @if (appState.Cmd.ToLower().Contains("coursetest"))
                    {
                   <input class="form-check-input" style="margin-left:5px;margin-right:5px;" type="checkbox" @bind="tst.IsSelected" />
                    }
                    @if ((_cmd == "showStatistics") & (!appState.Cmd.ToLower().Contains("coursetest")))
                    {
                    <span style="@stl font-weight:bold; @testRtlStatus">@i - @tst.TestTitle
                        <br />
                        <button class="btn btn-link" style="@testRtlStatus" @onclick="()=>BtnEditCourseTest(tst.TestId)">
                            <img src="icons/icoEditPen_bt_1.png" title="Edit Test" alt="Edit" width="20px"/>
                        </button>
                        <button class="btn btn-link" style="@testRtlStatus" @onclick="()=>BtnShowCourseTestStats(tst)">
                            <img src="icons/icoPie_bt_1.png" title="Edit Test" alt="Edit" width="25px"/>
                        </button>
                    </span>
                    }
                else
                    {
                    <span style="@stl font-weight:bold; @testRtlStatus">@i - @tst.TestTitle</span>
                    }
            </div>
            @* Show-TestOptions *@
            @foreach (var opt in tst.TestOptions)
                {
                if (appState.Cmd.EndsWith("raw"))
                    {
                    <div style="@stl; @optRtlStatus"> - @opt.TestOptionTitle</div>
                    }
                else
                    {
                    if((opt.TestOptionId == tst.StudentExamTestKey) & (opt.TestOptionId == tst.StudentExamTestAns))
                        {
                        <div style="@stl color:darkgoldenrod;font-weight:bold; @optRtlStatus"> - @opt.TestOptionTitle</div>
                        }
                    else if((opt.TestOptionId == tst.StudentExamTestKey) & (opt.TestOptionId != tst.StudentExamTestAns))
                        {
                        <div style="@stl color:royalblue; @optRtlStatus"> - @opt.TestOptionTitle</div>
                        }
                    else if((opt.TestOptionId != tst.StudentExamTestKey) & (opt.TestOptionId == tst.StudentExamTestAns))
                        {
                        <div style="@stl color:indianred; @optRtlStatus"> - @opt.TestOptionTitle</div>
                        }
                    else if((opt.TestOptionId != tst.StudentExamTestKey) & (opt.TestOptionId != tst.StudentExamTestAns))
                        {
                        <div style="@stl color:black; @optRtlStatus"> - @opt.TestOptionTitle</div>
                        }
                    }
                }
            @if (_cmd != "useSmallFont")
                {
                <hr style="border-color:red" />
                }
            @if ((appState.Cmd == "ShowCourseTestStats") & (appState.TestId == tst.TestId))
                {
                <div style="font-weight:bold;">Students:</div>
                <div style="padding-left:30px;">
                    <div style="font-style:italic;color:dodgerblue">@nStudentsVisited Visits</div>
                    <div style="font-weight:bold">@nStudentsAnswered Answers</div> 
                    <div style="padding-left:15px;">@nStudentsAnsweredCorrectly Correct</div> 
                    <div style="padding-left:15px;">@nStudentsAnsweredIncorrectly Incorrect</div>
                    <div style="font-weight:bold;">@nStudentsNotAnswered noAnswer</div>                
                </div>
                <br /> 
                <div class="d-flex justify-content-center">
                    <MudChart ChartType="ChartType.Donut"
                        InputData="@(new double[] {nStudentsSlectedOpt1, nStudentsSlectedOpt2, nStudentsSlectedOpt3, nStudentsSlectedOpt4, nStudentsSlectedOpt5 })"
                        InputLabels="@(new[] { "a: "+ @nStudentsSlectedOpt1,"b: "+ @nStudentsSlectedOpt2, "c: "+ @nStudentsSlectedOpt3, "d: "+ @nStudentsSlectedOpt4, "e: "+ @nStudentsSlectedOpt5, })"
                        Width="100px" Height="100px" />
                    <br /> 
                </div>
                <hr style="color:red" />
                }
            }
            @if (appState.Cmd.ToLower().Contains("coursetest"))
                {
                <div class="container mt-2">
                    <div class="card">
                        <div class="card-body" style="background-color:whitesmoke">
                            <span style="font-weight:bold;color:royalblue;padding-bottom:5px;">Include selected tests to Exam:</span>
                                <select class="form-select d-inline" @bind="intExamId" style="width:80%; background-color:white">
                                    <option value="0"> Select an Exam... </option>
                                    @foreach (Exam exam in lstExams)
                                        {
                                        <option value="@exam.ExamId"> @exam.ExamTitle </option>
                                        }
                                </select>
                                <button class="btn btn-link" type="submit" @onclick="BtnAddSelectedTestsToAnExam">
                                    <img src="/icons/icoSave_bt_1.png" width="28" />
                                </button>
                        </div>
                    </div>
                </div>
                <hr style="color:red" />
                }
            <div style="text-align: center;">
                <button class="btn btn-link" type="submit" @onclick="BtnBack">
                    <img src="/icons/icoBack_bt_1.png" width="30" />
                </button>
            </div>
    </EditForm>
    }
    <script>
        window.scrollToTop = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }; 
    </script>

@code {
    public bool _hasFetched = false;
    private ElementReference txtPageNumber;
    private int intPageNumber = 1;        //actual page used for numbering
    private int intPendingPageNumber = 1; //value typed in the input (prevent changing i (index number) of tests in list)
    User user = new User ();
    Course course = new Course ();
    List<StudentExamTest> lstxTests = new List<StudentExamTest> ();
    List<Test> lstTests = new List<Test> ();
    List<Exam> lstExams = new List<Exam> ();
    private int intExamId;
    int i = 0;
    int StudentId;
    string _cmd;
    string stl;
    public int nStudents = 0;
    public int nStudentsVisited = 0;
    public int nStudentsAnswered = 0;
    public int nStudentsAnsweredCorrectly = 0;
    public int nStudentsAnsweredIncorrectly = 0;
    public int nStudentsNotAnswered = 0;
    public int nStudentsSlectedOpt1 = 0;
    public int nStudentsSlectedOpt2 = 0;
    public int nStudentsSlectedOpt3 = 0;
    public int nStudentsSlectedOpt4 = 0;
    public int nStudentsSlectedOpt5 = 0;

    //LifeCycleEvents
    protected override async Task OnInitializedAsync()
        {
        appState.OnChange += TriggerRender;
        if(Convert.ToInt32(appState.UserLoginStatus) != 1)
            {
            Navman.NavigateTo ("/Login");
            }
        switch (appState.Cmd?.ToLower())
            {
            case "coursetest":
            case "coursetestraw":
                    {
                    course = new Course () { CourseId = Convert.ToInt32 (appState.CourseId) };
                    lstExams = await feService.Read_Exams (course.CourseId);
                    await BtnReadTestsPaginated (1);
                    break;
                    }
            case"examtests":
            case"examtestsraw":
                    {
                    List<Test> lstExamTests = await feService.Read_TestsByExamId (Convert.ToInt32 (appState.ExamId), true);
                    foreach(Test tst in lstExamTests)
                        {
                        lstxTests.Add (new StudentExamTest()
                        {
                        StudentExamId = tst.CourseId,
                        TestId = tst.TestId,
                        StudentExamTestKey = 0,
                        StudentExamTestAns = 0,
                        TestIndex = 0,
                        TestTitle = tst.TestTitle,
                        TestType = tst.TestType,
                        CourseTopicId = tst.TopicId,
                        CourseTopicTitle = "",
                        TestTags = tst.TestTags,
                        TestLevel = tst.TestLevel,
                        TestOptions = tst.TestOptions
                        }
                        );}
                    //find and set key
                    foreach(StudentExamTest t in lstxTests)
                        {
                        foreach(TestOption opt in t.TestOptions)
                            {
                            if (opt.TestOptionTags >= 2)
                                {
                                t.StudentExamTestKey = opt.TestOptionId;
                                break;
                                }
                            }
                        }
                    break;
                    }
            case"studentexam":
            case"studentexamraw":
                    {
                    lstxTests = await feService.Read_StudentExamTests (Convert.ToInt32 (appState.StudentExamId),true);
                    break;
                    }
            case "studentcourse":
            case "studentcourseraw":
                    {
                    List<StudentCourseTest> lstStudentCourseTests = await feService.Read_StudentCourseTests (Convert.ToInt32 (appState.StudentCourseId), true);
                    //copy data to a shared satandard list so that html code uses it
                    foreach(StudentCourseTest sctest in lstStudentCourseTests)
                        {
                        lstxTests.Add (new StudentExamTest()
                        {
                        StudentExamId = sctest.StudentCourseId,
                        TestId = sctest.TestId,
                        StudentExamTestKey = sctest.TestKey,
                        StudentExamTestAns = sctest.UserAns,
                        TestIndex = sctest.TestIndex,
                        TestTitle = sctest.TestTitle,
                        TestType = sctest.TestType,
                        CourseTopicId = sctest.CourseTopicId,
                        CourseTopicTitle = sctest.CourseTopicTitle,
                        TestTags = sctest.TestTags,
                        TestLevel = sctest.TestLevel,
                        TestOptions = sctest.TestOptions
                        }
                        );}
                    break; 
                    }
            }
        StudentId = Convert.ToInt32(appState.UserId);
        stl = "";
        _hasFetched = true;
        } 
    private void TriggerRender()
        {
        InvokeAsync(StateHasChanged);
        }
    public void Dispose()
        {
        appState.OnChange -= TriggerRender;
        }
    //btns
    public void BtnShowAnswers()
        {
        string _appstatecmd = appState.Cmd ?? "";
        _appstatecmd = (_appstatecmd.EndsWith ("raw")) ? (Strings.Left (_appstatecmd, _appstatecmd.Length - 3)) : (_appstatecmd + "raw");
        appState.SetCmd (_appstatecmd);
        i = 0;
        }
    public void BtnCourseExamStats()
        {
        _cmd = (_cmd == "showStatistics")? "": "showStatistics";
        i = 0;
        }
    public void BtnChangeFontSize()
        {
        _cmd = (_cmd == "useSmallFont")? "": "useSmallFont";
        i = 0;
        }
    public async Task BtnReadTestsPaginated(int newPage)
        {
        intPageNumber = newPage;
        lstTests = await feService.Read_TestsByCourseId (Convert.ToInt32 (appState.CourseId), intPageNumber, true);
        lstxTests.Clear ();
        foreach(Test tst in lstTests)
            {
            lstxTests.Add (new StudentExamTest()
                {
                StudentExamId = tst.CourseId,
                TestId = tst.TestId,
                StudentExamTestKey = 0,
                StudentExamTestAns = 0,
                TestIndex = 0,
                TestTitle = tst.TestTitle,
                TestType = tst.TestType,
                CourseTopicId = tst.TopicId,
                CourseTopicTitle = "",
                TestTags = tst.TestTags,
                TestLevel = tst.TestLevel,
                TestOptions = tst.TestOptions
                }
            );}
        //find and set key
        foreach(StudentExamTest t in lstxTests)
            {
            foreach(TestOption opt in t.TestOptions)
                {
                if (opt.TestOptionTags >= 2)
                    {
                    t.StudentExamTestKey = opt.TestOptionId;
                    break;
                    }
                }
            }
        }
    public async Task BtnEditCourseTest(int testId)
        {
        appState.SetTestId (testId);
        appState.SetReturnPage ("/T_ReportTests");
        Navman.NavigateTo ("/T_CourseTest");
        }
    public async Task BtnShowCourseTestStats(StudentExamTest studentExamTest)
        {
        _hasFetched = false;
        //Read StudentExam and StudentExamTest Across Students
        List<StudentExamTest> lstStudentsExamTest = await feService.Read_StudentsExamTest (studentExamTest);
        //calcs ...
        nStudents = lstStudentsExamTest.Count;
        nStudentsVisited = 0;
        nStudentsAnswered = 0;
        nStudentsAnsweredCorrectly = 0;
        nStudentsAnsweredIncorrectly = 0;
        nStudentsNotAnswered = 0;
        nStudentsSlectedOpt1 = 0;
        nStudentsSlectedOpt2 = 0;
        nStudentsSlectedOpt3 = 0;
        nStudentsSlectedOpt4 = 0;
        nStudentsSlectedOpt5 = 0;
        foreach(StudentExamTest tst in lstStudentsExamTest)
            {
            if((tst.StudentExamTestTags & 1) == 1)
                {
                nStudentsVisited++;
                }
            if((tst.StudentExamTestTags & 4) == 4)
                {
                nStudentsAnswered++;
                if(tst.StudentExamTestAns == tst.StudentExamTestKey)
                    {
                    nStudentsAnsweredCorrectly++;
                    }
                else
                    {
                    nStudentsAnsweredIncorrectly++;                    
                    }
                }
            if((tst.StudentExamTestAns == studentExamTest.Opt1Id))
                {
                nStudentsSlectedOpt1++;
                }
            if((tst.StudentExamTestAns == studentExamTest.Opt2Id))
                {
                nStudentsSlectedOpt2++;
                }
            if((tst.StudentExamTestAns == studentExamTest.Opt3Id))
                {
                nStudentsSlectedOpt3++;
                }
            if((tst.StudentExamTestAns == studentExamTest.Opt4Id))
                {
                nStudentsSlectedOpt4++;
                }
            if((tst.StudentExamTestAns != 0) & (tst.StudentExamTestAns == studentExamTest.Opt5Id))
                {
                nStudentsSlectedOpt5++;
                }
            }
        nStudentsNotAnswered = nStudentsVisited - nStudentsAnswered;
        appState.SetTestId (studentExamTest.TestId);
        appState.SetCmd ("ShowCourseTestStats");
        _hasFetched = true;
        StateHasChanged ();
        }
    public async Task BtnAddSelectedTestsToAnExam()
        {
        if (intExamId <= 0)
            {
            await JS.InvokeVoidAsync ("alert", "Select an exam!");            
            }
        else
            {
            var selectedIds = lstxTests
                .Where(t => t.IsSelected)
                .Select(t => t.TestId)
                .ToList();
            int testCount = 0;
            foreach(int intTestId in selectedIds)
                {
                ExamTest examTest = new ExamTest () {ExamId = intExamId, TestId= intTestId };
                int result = await feService.Create_ExamTest (examTest);
                if (result > 0)
                    {
                    testCount++;
                    Console.WriteLine($"Test {testCount} added to Exam");
                    }
                }
            appState.SetCmd ("coursetest");
            StateHasChanged ();
            await JS.InvokeVoidAsync ("alert", $"\n\n{testCount} Tests was added to the Exam Successfully");            
            }
        }
    public void BtnBack()
        {
        if (appState.ReturnPage != "/T_ReportTests")
            {
            Navman.NavigateTo (appState.ReturnPage?? "/Login");
            }
        else
            {
            Navman.NavigateTo ("/T_Courses");
            }
        }
    }
