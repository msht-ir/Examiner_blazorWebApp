@page "/"
@page "/Login"

@using ExaminerB.Service
@inject NavigationManager Navman
@inject AppState appState
@inject HttpClient http
@inject FeService feService
@inject IJSRuntime JS
@implements IDisposable
@inject ISnackbar Snackbar

<PageTitle>Examiner Home</PageTitle>
<div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <br />
    <h2 style="color:gray">e<span style="color:indianred">x</span>aminer<span style="font-style:italic;font-size:small;color:royalblue"> WebApp </span> <span style="font-style:italic;font-size:small;color:indianred"> - @appState.UserRole </span></h2>
    <img src="/images/gifExam01.gif" width="180" style="margin-left:10px;margin-right:10px" />
    <br />
    <EditForm Model="user" OnValidSubmit="BtnLogin" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <DataAnnotationsValidator></DataAnnotationsValidator>
        <div class="mb-3 d-flex gap-1">
            <MudSelect T="string" @ref="refRole" Label="Role نقش" Value="user.UserRole" ValueChanged="@((string role) => OnRoleChanged(role))" Class="w-auto" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" Style="font-size:small;">
                <MudSelectItem Value=@("student")>Student</MudSelectItem>
                <MudSelectItem Value=@("teacher")>Teacher</MudSelectItem>
            </MudSelect>
            <br />
            @if(user.UserRole == "student")
                {
                <MudSelect T="int" @ref="refTeacher" Label="Teacher استاد" Value="TeacherId" ValueChanged="OnTeacherChanged" Class="w-auto my-select" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" Style="color:royalblue;width:100px;font-size:small;">
                    <MudSelectItem Value="0">Your teacher?</MudSelectItem>
                    @foreach (var teacher in lstTeachers) { <MudSelectItem Value="@teacher.UserId">@teacher.UserNickname</MudSelectItem> }
                </MudSelect>
                <MudSelect T="int" @ref="refGroup" Label="Class کلاس" Value="GroupId" ValueChanged="OnGroupChanged" Class="w-auto my-select" Variant="Variant.Outlined" Dense="true" Margin="Margin.Dense" Style="color:royalblue;width:100px;font-size:small;">
                    <MudSelectItem Value="0">Your Class?</MudSelectItem>
                    @foreach (var group in lstGroups) { <MudSelectItem Value="@group.GroupId">@group.GroupName</MudSelectItem> }
                </MudSelect>
                }
        </div>
        <MudTextField @ref="refUser" @bind-Value="user.UserName" Label="Username يوزر" Variant="Variant.Outlined" Autocomplete="off" Dense="true" Margin="Margin.Dense" Class="my-textfield" />
        <MudTextField @ref="refPass" @bind-Value="user.UserPass" Label="Password پسورد" Variant="Variant.Outlined" Autocomplete="off" Dense="true" Margin="Margin.Dense" Class="my-textfield" InputType="InputType.Password"/>
        <button class="btn btn-link">
            <img src="/images/gifUser1.gif" width="60" />
        </button>
    </EditForm>
</div>
<hr style="color:blueviolet"/>
<script>
    document.getElementById("txtUser").focus();
    document.getElementById("txtUser").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            document.getElementById("txtPass").focus();}});
</script>

@code {
    //private ElementReference refRole;
    private MudSelect<string> refRole;
    private User user = new User { UserRole = "student" };

    //private ElementReference refTeacher;
    private MudSelect<int> refTeacher;
    private int selectedTeacherId;

    //private ElementReference refGroup;
    private MudSelect<int> refGroup;

    // private ElementReference refUser;
    private MudTextField<string> refUser;

    // private ElementReference refPass;
    private MudTextField<string> refPass;

    private bool _firstRender = true;
    private int TeacherId = 0;
    private int GroupId = 0;
    private List<User> lstTeachers = new List<User> (); 
    private List<Group> lstGroups = new List<Group> (); 

    //LifeCycleEvents
    protected override async Task OnInitializedAsync()
        {
        appState.OnChange += StateHasChanged;
        appState.OnChange += TriggerRender;
        appState.SetUserLoginStatus (0);
        appState.SetStudentTags (0);
        appState.SetUserName ("");
        StateHasChanged ();
        lstTeachers = await feService.Read_Teachers ();
        } 
    protected override async Task OnAfterRenderAsync(bool firstRender)
        {
        if (_firstRender)
            {
            _firstRender = false;
            await Task.Delay (1);
            await refRole.FocusAsync ();        
            }
        }
    private void TriggerRender()
        {
        InvokeAsync(StateHasChanged);
        }
    public void Dispose()
        {
        appState.OnChange -= TriggerRender;
        }
    //btns
    public async Task BtnLogin ()
        {
        //via 'OnValidSubmic of EditForm'
        if ((user.UserRole == "student") & (GroupId == 0))
            {
            Snackbar.Add("Select your Class (group)!", Severity.Warning); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
            //old code: await JS.InvokeVoidAsync ("alert", "Select your Class (group)!");
            return;
            }
        user.UserId = 0;
        user.UserTags = 0;
        user.GroupId = GroupId;
        user = await feService.Login(user) ?? new User { UserRole = "student" };        
        if (user.UserId != 0)
            {
            switch (user.UserRole)
                {
                case "student":
                        {
                        appState.SetUserLoginStatus (1);
                        appState.SetUserId (user.UserId);
                        appState.SetUserName (user.UserName);
                        appState.SetUserPass (user.UserPass);
                        appState.SetUserTags (user.UserTags);
                        appState.SetUserRole (user.UserRole);
                        appState.SetUserNickname (user.UserNickname);
                        //navigate
                        await Task.Delay(1);
                        Navman.NavigateTo("/S_Student");
                        Snackbar.Add($"\n\nWelcome {user.UserNickname} !", Severity.Success); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                        break;
                        }
                case "teacher":
                        {
                        appState.SetUserLoginStatus (1);
                        appState.SetUserId (user.UserId);
                        appState.SetUserName (user.UserName);
                        appState.SetUserPass (user.UserPass);
                        appState.SetUserTags (user.UserTags);
                        appState.SetUserRole (user.UserRole);
                        appState.SetUserNickname (user.UserNickname);
                        //navigate
                        await Task.Delay(1);
                        Navman.NavigateTo("/T_SwitchBoard"); 
                        Snackbar.Add($"\n\nWelcome {user.UserNickname} !", Severity.Success); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                        break;
                        }
                }
            }
        else
            {
            Snackbar.Add("Incorrect Username or Password!", Severity.Warning); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
            user.UserRole = "student";
            GroupId = 0;
            return;
            }
        } 
    //methods
    public async Task HandleUserKeyDown (KeyboardEventArgs e)
        {
        if (e.Key == "Enter")
            {
            await Task.Delay (1);
            await refPass.FocusAsync ();
            }
        }
    private async Task OnTeacherChanged(int newValue) 
        {
        //update TeacherId from the event
        TeacherId = newValue;
        user.UserId = TeacherId;
        user.UserName = "-"; //just because this field is required 
        user.UserPass = "-------";//just because this field is required
        user.UserRole = "student";
        user.UserTags = 0;
        user.GroupId = 0;
        user.UserNickname = "";
        lstGroups = await feService.Read_Groups (user, false, false);
        GroupId = 0;
        StateHasChanged();
        await Task.Delay (1);
        await refGroup.FocusAsync ();
        } 
    private async Task OnRoleChanged(string newRole) 
        {
        user.UserRole = newRole;
        StateHasChanged(); //render page to make elements appear on DOM
        await Task.Yield(); //wait until render is completed
        if (user.UserRole == "teacher")
            {
            await refUser.FocusAsync();
            }
        else if (user.UserRole == "student")
            {
            await refTeacher.FocusAsync();
            }
        }
    private async Task OnGroupChanged(int newValue) 
        {
        GroupId = newValue;
        if (user.UserRole == "student")
            {
            StateHasChanged(); //render page to make elements appear on DOM
            user.UserName = ""; //just because this field is required 
            user.UserPass = "";//just because this field is required
            await refUser.FocusAsync();
            }
        }


}
