@page "/S_ChangePassword"
@using ExaminerB.Service
@using System.ComponentModel.DataAnnotations
@rendermode InteractiveServer
@inject ProtectedSessionStorage sessionStorage
@inject NavigationManager Navman
@inject AppState appState
@inject FeService feService
@implements IDisposable

@if (appState.Message != "")
    {
    <h5 style="text-align:center;color:indianred">@appState.Message</h5>
    }
    <br />
    <hr style="color:indianred" />
    <div class="d-flex flex-column align-items-center justify-content-center text-center">
        <div style="">
            <img src="/icons/icoKey_blt_1.png" width="80" style="margin-left:10px;margin-right:10px" />
        </div>
        <br />
        <br />
        <div class="card" style="width: 22rem;">
            <div class="card-body">
                <h6 style="color:royalblue">Change Password for <span style="color:indianred"> @appState.UserName</span> <span style="font-size:small; color:gray"> : @appState.UserRole</span></h6>
                    <br />
                    <EditForm Model="pass" OnValidSubmit="BtnChangePassword" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <DataAnnotationsValidator></DataAnnotationsValidator>
                        <div class="mb-3">
                            <input @ref="refPassCurrent" @bind="pass.Current" type="password" class="form-control" placeholder="Current Password"/>
                        </div>
                        <div class="mb-3">
                            <input @ref="refPassNew" @bind="pass.New" type="password" class="form-control" placeholder="New password"/>
                        </div>
                        <div class="mb-3">
                            <input @ref="refPassRepeat" @bind="pass.Repeat" type="password" class="form-control" placeholder="Repeat password"/>
                        </div>
                        <div style="color:indianred; text-align:left">
                            <ValidationSummary />
                        </div>

                        <button class="btn btn-link">
                            <img src="/icons/icoSave_cw_1.png" width="35" />
                        </button>
                        <br />
                        <br />
                    </EditForm>
                </div>
            </div>
    </div>

@code {
    private bool _firstRender = true;
    User user = new User();
    private class Pass
        {
        [Required (ErrorMessage = "enter your current password")] 
        public string Current { get; set; } = "";
        [Required (ErrorMessage = "enter new password?")] 
        public string New { get; set; } = "";
        [Required (ErrorMessage = "repeat the new password!")] 
        public string Repeat { get; set; } = "";
        }
    private Pass pass = new Pass ();
    private ElementReference refPassCurrent;
    private ElementReference refPassNew;
    private ElementReference refPassRepeat;
    string currentUserPass = "";
    int loginStatus = 0;
    string userRole  = "";
    //LifeCycleEvents
    protected override async Task OnInitializedAsync()
        {
        appState.OnChange += TriggerRender;
        userRole = appState.UserRole ??"";
        loginStatus = Convert.ToInt32(appState.UserLoginStatus);
        }
    protected override async Task OnAfterRenderAsync(bool firstRender)
        {
        currentUserPass = appState.UserPass ?? "";
        if ((loginStatus == 0))
            {
            Navman.NavigateTo("/Login");
            }
        if (_firstRender)
            {
            _firstRender = false;
            appState.SetMessage("");
            await refPassCurrent.FocusAsync();
            }
        }
    private void TriggerRender()
        {
        InvokeAsync(StateHasChanged);
        }
    public void Dispose()
        {
        appState.OnChange -= TriggerRender;
        }
    //btns
    public async Task BtnChangePassword()
        {
        //user: a student or a teacher -- will be distinguished in SrvUpdate_UserPassword by user.UserRole
        int userId = Convert.ToInt32(appState.UserId);
        if ((pass.New == pass.Repeat) && (pass.New.Length > 3) && (pass.Current == currentUserPass))
            {
            user.UserId = userId;
            user.UserName = appState.UserName ?? "default name";
            user.UserPass =pass.New;
            user.UserRole = appState.UserRole ?? "";
            if (await feService.Update_UserPassword(user))
                {
                appState.SetMessage ("Student Password Changed");
                Navman.NavigateTo ("/Login");
                }
            else
                {
                appState.SetMessage ("Error!?");
                }
            }
        else
            {
            appState.SetMessage ("Passwords not match");
            }
    }
}
