@page "/ChangePassword"
@using ExaminerB.Service
@using System.ComponentModel.DataAnnotations
@inject ProtectedSessionStorage sessionStorage
@inject NavigationManager Navman
@inject AppState appState
@inject FeService feService
@implements IDisposable

<br />
<div class="d-flex flex-column align-items-center justify-content-center text-center">
    <div style="">
        <img src="/img/icoKey_blt_1.png" width="60" style="margin-left:10px;margin-right:10px" />
    </div>
    <br />
    <br />
    <div class="card" style="width: 22rem;">
        <div class="card-body">
            <h6 style="color:royalblue">Change Password for <span style="color:indianred"> @appState.UserNickname</span> <span style="font-size:small; color:gray; font-style:italic">  @appState.UserRole</span></h6>
                <br />
                <EditForm Model="pass" OnValidSubmit="BtnChangePassword" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <DataAnnotationsValidator></DataAnnotationsValidator>
                    <ValidationSummary></ValidationSummary>
                    <div class="mb-3">
                        <input @ref="refPassNickname" @bind="pass.Nickname" type="text" class="form-control" placeholder="Nickname"/>
                    </div>
                    <div class="mb-3">
                        <input @ref="refPassCurrent" @bind="pass.Current" type="password" class="form-control" placeholder="Current Password"/>
                    </div>
                    <div class="mb-3">
                        <input @ref="refPassNew" @bind="pass.New" type="password" class="form-control" placeholder="New password"/>
                    </div>
                    <div class="mb-3">
                        <input @ref="refPassRepeat" @bind="pass.Repeat" type="password" class="form-control" placeholder="Repeat password"/>
                    </div>
                    <div style="color:indianred; text-align:left">
                        <ValidationSummary />
                    </div>

                    <button class="btn btn-link">
                        <img src="/img/icoSave.png" width="28" />
                    </button>
                    <br />
                    <br />
                </EditForm>
            </div>
    </div>
</div>

@code {
    private bool _firstRender = true;
    User user = new User();
    private class Pass
        {
        [Required (ErrorMessage = "enter your Nickname")] 
        public string Nickname { get; set; } = "";
        [Required (ErrorMessage = "enter your current password")] 
        public string Current { get; set; } = "";
        [Required (ErrorMessage = "enter new password?")] 
        public string New { get; set; } = "";
        [Required (ErrorMessage = "repeat the new password!")] 
        public string Repeat { get; set; } = "";
        }
    private Pass pass = new Pass ();
    private ElementReference refPassNickname;
    private ElementReference refPassCurrent;
    private ElementReference refPassNew;
    private ElementReference refPassRepeat;
    string currentUserPass = "";
    int loginStatus = 0;
    string userRole  = "";
    //LifeCycleEvents
    protected override async Task OnInitializedAsync()
        {
        appState.OnChange += TriggerRender;
        if(Convert.ToInt32(appState.UserLoginStatus) != 1)
            {
            Navman.NavigateTo ("/Login");
            }
        userRole = appState.UserRole ??"";
        pass.Nickname = appState.UserNickname ?? "";
        loginStatus = Convert.ToInt32(appState.UserLoginStatus);
        currentUserPass = appState.UserPass ?? "";
        pass.Nickname = appState.UserNickname ?? "";
        }
    protected override async Task OnAfterRenderAsync(bool firstRender)
        {
        if ((loginStatus == 0))
            {
            Navman.NavigateTo("/Login");
            }
        if (_firstRender)
            {
            _firstRender = false;
            await refPassNickname.FocusAsync ();
            }
        }
    private void TriggerRender()
        {
        InvokeAsync(StateHasChanged);
        }
    public void Dispose()
        {
        appState.OnChange -= TriggerRender;
        }
    //btns
    public async Task BtnChangePassword()
        {
        //user: a student or a teacher -- will be distinguished in SrvUpdate_UserPassword by user.UserRole
        int userId = Convert.ToInt32(appState.UserId);
        if ((pass.New == pass.Repeat) && (pass.New.Length > 3) && (pass.Current == currentUserPass))
            {
            user.UserId = userId;
            user.UserName = appState.UserName ?? "default name";
            user.UserPass =pass.New;
            user.UserNickname =pass.Nickname;
            user.UserRole = appState.UserRole ?? "";
            if (await feService.Update_UserPassword(user))
                {
                Navman.NavigateTo ("/Login");
                }
            }
    }
}
