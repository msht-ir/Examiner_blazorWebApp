@page "/T_ReportStudents/{mode}/{Id}"
@using ExaminerB.Service
@inject FeService feService
@inject NavigationManager Navman
@inject AppState appState
@inject IJSRuntime JS
@implements IDisposable
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@* mode: {student|students} *@
<h1 style="text-align:center;color:lightsteelblue">e<span style="color:lightpink">x</span>aminer<span style="font-size:small"> Teacher</span></h1>
<hr style="color:red"/>
<h4 style="text-align:center">Students's Exams and Courses</h4>
<hr style="color:red"/>
@if (!_hasFetched)
    {
    <_ScanSheets />
    }
else
    {
    <EditForm Model="lstStudents" style="max-width:600px; margin: 0 auto;">
    <div class="accordion" id="accordionReport">
        @foreach(User student in lstStudents)
        {
        var collapseId = $"Student{student.UserId}";
        <div class="accardion-item mb-1">
            <h4 class="accordion-header">
                <button
                    class="accordion-button collapsed"
                    style="background-color:whitesmoke; color:black;"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#@collapseId"
                    aria-expanded="true"
                    aria-controls="@collapseId">
                    <h6 style="color:indianred;">@student.UserNickname - @student.UserName</h6>
                </button>
            </h4>
            <div id="@collapseId" class="accardion-collapse collapse" data-bs-parent="#accordionReport">
                <div class="accardion-body" >
                    @* Accs *@
                    <MudContainer Class="mt-2 px-0">
                        <MudCard Class="mx-0">
                            <MudCardContent Style="background-color:whitesmoke;">
                                <MudTextField @bind-Value="student.UserName" Label="Username" Variant="Variant.Outlined" Margin="Margin.Dense" Autocomplete="off" Class="my-textfield" />
                                <MudTextField @bind-Value="student.UserPass" Label="Password" Variant="Variant.Outlined" Margin="Margin.Dense" Autocomplete="off" Class="my-textfield" />
                                <MudTextField @bind-Value="student.UserNickname" Label="Nickname" Variant="Variant.Outlined" Margin="Margin.Dense" Autocomplete="off" Class="my-textfield" Style="font-family:'Segoe UI'" />
                                <div class= "d-flex align-items-center gap-3">
                                    <MudCheckBox @bind-Value="student.IsActive" Label="active" Color="Color.Primary"/>
                                    <MudCheckBox @bind-Value="student.CanChangePass" Label="password" Color="Color.Primary"/>
                                    <button class="btn btn-link" style="border:none" title="Save Accs" @onclick="()=>BtnUpdateStudent(student)">
                                        <img src="/img/icoSave2.png" width="22" />
                                    </button>
                                </div>
                            </MudCardContent>
                        </MudCard>
                    </MudContainer>
                    @* Student_Courses *@
                    <MudContainer Class="mt-2 px-0">
                        <MudCard Class="mx-0">
                            <MudCardContent Style="background-color:whitesmoke;">
                                <h4>Courses</h4>
                                @foreach (StudentCourse stCrs in student.StudentCourses)
                                    {
                                    <hr />
                                    <div class="d-flex gap-1" style="color:indianred; font-weight:bold;">
                                        @stCrs.CourseName
                                        <span style="color:Black; font-weight:normal; font-size:small">( @stCrs.CorrectAnswers / @stCrs.NumberOfTests )</span>
                                    </div>
                                    <div class="d-flex gap-1 juctity-content:center align-items:center">
                                        <button class="btn btn-link" style="border:none" title="Report Tests ( + answeres )" @onclick='()=>BtnReviewStudentTestsSheet(stCrs.StudentCourseId, "studentcoursetests")'>
                                            <img src="/img/icoReport1.png" width="20" />
                                        </button>
                                        <button class="btn btn-link" style="border:none" title="Delete Course !" @onclick="()=>BtnDeleteStudentCourse(stCrs.StudentCourseId)">
                                            <img src="/img/icoDelete1.png" width="22" />
                                        </button>
                                        <button class="btn btn-link" style="border:none" title="Save Accs" @onclick="()=>BtnUpdateStudentCourseTags(stCrs)">
                                            <img src="/img/icoSave2.png" width="22" />
                                        </button>
                                        <MudCheckBox @bind-Value="stCrs.IsActive" Label="act"  Color="Color.Success"/>
                                        <MudCheckBox @bind-Value="stCrs.Retry" Label="ret" Color="Color.Success"/>
                                        <MudCheckBox @bind-Value="stCrs.Review" Label="rev" Color="Color.Success"/>
                                    </div>
                                    }
                            </MudCardContent>
                        </MudCard>
                    </MudContainer>
                    @* StudentExams *@
                    <h3 style="margin-top:20px">Exams</h3>
                    @foreach (StudentExam exm in student.StudentExams)
                        {
                        <MudContainer Class="mt-2 px-0">
                            <MudCard Class="mx-0">
                                <MudCardContent Style="background-color:whitesmoke;">
                                    <table class="table table-borderless">
                                        <tr style="align-content:center">
                                            <td style="color:indianred;font-weight:bold;">
                                                <span style="color:gray;font-weight:bold;padding:0px;">@exm.CourseName</span>
                                                <br /> @exm.ExamTitle 
                                                <br /> <span style="color:black;font-weight:normal;padding:0px;">@exm.ExamDateTime</span>
                                                <br />
                                                @if((exm.StudentExamTags & 4) == 4)
                                                    {
                                                    <button class="btn btn-link" style="border:none" @onclick="()=>BtnResetStudentExam(exm)" >
                                                        <img src="/img/icoClock2.png" width="24" />
                                                    </button>
                                                    }
                                                else if((exm.StudentExamTags & 6) == 2)
                                                    {
                                                    <button class="btn btn-link" style="border:none" @onclick="()=>BtnSetStudentExamAsFinished(exm)" >
                                                        <img src="/img/icoEditPen.png" width="24" />
                                                    </button>
                                                    } 
                                                else if ((exm.StudentExamTags & 2) == 0)
                                                    {
                                                    <button class="btn btn-link" style="border:none" @onclick="()=>BtnSetStudentExamAsFinished(exm)" >
                                                        <img src="/img/icoGo1.png" width="24" />
                                                    </button>
                                                    }
                                                <button class="btn btn-link" style="border:none" @onclick='()=>BtnReviewStudentTestsSheet(exm.StudentExamId, "studentexamtests")' >
                                                    <img src="/img/icoReport1.png" width="22" />
                                                </button>
                                                <button class="btn btn-link" style="border:none" @onclick="()=>BtnDeleteStudentExam(exm.StudentExamId)" >
                                                    <img src="/img/icoDelete1.png" width="24" />
                                                </button>
                                                <button class="btn btn-link" style="border:none" @onclick="()=>BtnUpdateStudentExam(exm)" >
                                                    <img src="/img/icoSave2.png" width="22" />
                                                </button>
                                            </td>  
                                            <td style="width:140px">
                                            @if(exm.StudentExamTags>=2)
                                                {
                                                <span style="text-align:left;padding:0px;">
                                                    Tests: @exm.ExamNTests <span style="font-weight:bold;font-size:smaller">(@exm.ExamDuration m)</span><br /> <span style="color:indianred">Point: @exm.StudentExamPoint.ToString("F2") /20 </span>                                        
                                                </span>
                                                }
                                            else if(exm.StudentExamTags==1)
                                                {
                                                <span style="text-align:left;padding:0px;">
                                                    Tests: @exm.ExamNTests <span style="font-weight:bold;font-size:smaller">(@exm.ExamDuration m)</span><br /> <span style="color:Green">satrted </span>
                                                </span>
                                                } 
                                            else
                                                {
                                                <span style="text-align:left;padding:0px;">
                                                    Tests: @exm.ExamNTests <span style="font-weight:bold;font-size:smaller">(@exm.ExamDuration m)</span><br /><span style="color:royalblue">new </span>
                                                </span>
                                                }
                                                <div style="margin:0; padding:0;">
                                                    <MudCheckBox @bind-Value="exm.Active" Label="active" Color="Color.Dark"/>
                                                    <MudCheckBox @bind-Value="exm.Review" Label="review" Color="Color.Dark"/>
                                                </div>
                                            </td>
                                        </tr>
                                </table>
                            </MudCardContent>
                        </MudCard>
                    </MudContainer>
                    }
                </div>
                <hr style="color:royalblue"/>
            </div>
        </div>
        }
    </div>
    </EditForm>
    <div style="text-align:center">
        <br />
        <hr style="color:red" />
        <button class="btn btn-link" @onclick="BtnBack">
            <img src="/img/icoBack3.png" width="40" />
        </button>
    </div>
    }
    <script>
        window.scrollToTop = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }; 
    </script>

@code {
    [Parameter] public string? mode { get; set; }
    [Parameter] public string? Id { get; set; }
    User user = new User ();
    List<User> lstStudents = new List<User> ();
    public bool _hasFetched = false;

    //LifeCycleEvents
    protected override async Task OnInitializedAsync()
        {
        appState.OnChange += TriggerRender;
        if(Convert.ToInt32(appState.UserLoginStatus) != 1)
            {
            Navman.NavigateTo ("/Login");
            }
        await ReadPageDataLists ();
        _hasFetched = true;
        } 
    private void TriggerRender()
        {
        InvokeAsync(StateHasChanged);
        }
    public void Dispose()
        {
        appState.OnChange -= TriggerRender;
        }
    //btns
    public void BtnReviewStudentTestsSheet(int Id, string mode)
        {
        appState.SetCmd (mode); //{studentexamtests|studentcoursetests}
        switch (mode)
            {
            case "studentexamtests":{appState.SetStudentExamId (Id); break; }
            case "studentcoursetests":{appState.SetStudentCourseId (Id); break; }
            }
        //moved to pageInit -- appState.SetReturnPage ($"/T_ReportStudents/{mode}/{Id}");
        Navman.NavigateTo ("/T_ReportTests");
        }
    public async Task BtnDeleteStudentCourse (int studentCourseId)
        {
        var message = new MarkupString($"<hr><span style='color:indianred'>Delete</span> student from this course?<div style='text-align:center'><img src='/img/icoDelete1.png' width='70'/></div><br><hr>");
        bool? confirmResult = await DialogService.ShowMessageBox(title: "Confirm", markupMessage: message, yesText: "Yes", cancelText: "No");
        if (confirmResult == true)
            {
            bool result = await feService.Delete_StudentCourse (studentCourseId);
            if(result)
                {
                int id = Convert.ToInt32 (Id);
                lstStudents.Clear();
                switch (mode)
                    {
                    case "S":
                            {
                            List<User> student = await feService.Read_StudentsByGCEMId (id, "S", 15);
                            student[0].StudentExams = await feService.Read_StudentExams (id, "ByStudentId");
                            student[0].StudentCourses = await feService.Read_StudentCourses (id, "ByStudentId");
                            lstStudents.Add (student[0]);
                            break;
                            }
                    default:
                            {
                            //modes: GCEM (not S)
                            var resultx = await feService.Read_StudentsByGCEMId (id, mode, 15);
                            lstStudents = resultx;
                            break;
                            }
                    }
                Snackbar.Add("Deleted", Severity.Success); //Severity.Warning | .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                appState.SetCmd("");
                StateHasChanged();
                }
            else
                {
                Snackbar.Add("Failed!", Severity.Error); //Severity.Warning | .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                }                        
            }
        }
    public async Task BtnDeleteStudentExam(int studentExamId)
        {
        var message = new MarkupString($"<hr><span style='color:indianred'>Delete</span> Exam (for this Student)?<br><br><div style='text-align:center'><img src='/img/icoDelete1.png' width='70'/></div><br><hr>");
        bool? confirmResult = await DialogService.ShowMessageBox(title: "Confirm", markupMessage: message, yesText: "Yes", cancelText: "No");
        if (confirmResult == true)
            {
            _hasFetched = false;
            bool result = await feService.Delete_StudentExam (studentExamId);
            if(result)
                {
                int id = Convert.ToInt32 (Id);
                Snackbar.Add("deleted", Severity.Success); //Severity.Warning | .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                lstStudents.Clear();
                switch (mode)
                    {
                    case "S":
                            {
                            List<User> students = await feService.Read_StudentsByGCEMId (id, "S", 15); //15 = all GCEM
                            students[0].StudentExams = await feService.Read_StudentExams (id, "ByStudentId");
                            students[0].StudentCourses = await feService.Read_StudentCourses (id, "ByStudentId");
                            //lstStudents.Add (student);
                            break;
                            }
                    default:
                            {
                            var resultx = await feService.Read_StudentsByGCEMId (id, "mode", 15);
                            lstStudents = resultx;
                            break;
                            }
                    }
                await ReadPageDataLists ();
                appState.SetCmd("");
                StateHasChanged();
                }
            else
                {
                Snackbar.Add("failed", Severity.Error); //Severity.Warning | .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                }  
            _hasFetched = true;                               
            }
        }
    //updateTags
    public async Task BtnSetStudentExamAsFinished(StudentExam studentExam)
        {
        //if(await JS.InvokeAsync<bool>("confirm", "\n Set Exam  @exm.ExamTitle  as Finished for this Student?"))
        var message = new MarkupString(@$"<hr>Set <span style='color:indianred'>{studentExam.ExamTitle}</span> as Finished?<br><br><div style='text-align:center'><img src='/img/icoClock2.png' width='70'/></div><br><hr>");
        bool? confirmResult = await DialogService.ShowMessageBox(title: "Confirm", markupMessage: message, yesText: "Yes", cancelText: "No");
        if (confirmResult == true)
            {
            bool result = await feService.Update_StudentExamTags (studentExam, "finishedOn");
            if(result)
                {
                Snackbar.Add("set as finished", Severity.Success); //Severity.Warning | .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                appState.SetCmd("");
                StateHasChanged();
                }
            else
                {
                Snackbar.Add("failed", Severity.Error); //Severity.Warning | .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                }
            }
        }
    public async Task BtnResetStudentExam(StudentExam studentExam)
        {
        var message = new MarkupString(@$"<hr>Activate <span style='color:indianred'>{studentExam.ExamTitle}</span> for this Student?<div style='text-align:center'><img src='/img/icoGo1.png' width='70'/></div><br><hr>");
        bool? confirmResult = await DialogService.ShowMessageBox(title: "Confirm", markupMessage: message, yesText: "Yes", cancelText: "No");
        if (confirmResult == true)
            {
            bool result = await feService.Update_StudentExamTags (studentExam, "finishedOff");
            if(result)
                {
                Snackbar.Add("activated", Severity.Success); //Severity.Warning | .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                appState.SetCmd("");
                StateHasChanged();
                }
            else
                {
                Snackbar.Add("failed", Severity.Error); //Severity.Warning | .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
                }                     
            }
        }
    private async Task BtnUpdateStudent(User student)
        {
        bool result = await feService.Update_Student (student);
        if (result)
            {
            Snackbar.Add($"saved", Severity.Success); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
            }
        else
            {
            Snackbar.Add($"failed", Severity.Error); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
            }
        }
    private async Task BtnUpdateStudentCourseTags(StudentCourse studentCourse)
        {
        bool result = await feService.Update_StudentCourse (studentCourse);
        if (result)
            {
            Snackbar.Add($"saved", Severity.Success); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
            }
        else
            {
            Snackbar.Add($"failed", Severity.Error); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
            }

        }
    private async Task BtnUpdateStudentExam(StudentExam studentExam)
        {
        bool result = await feService.Update_StudentExam (studentExam);
        if (result)
            {
            Snackbar.Add($"saved", Severity.Success); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
            }
        else
            {
            Snackbar.Add($"failed", Severity.Error); //Severity.Warning .Error | .Info | .Success --needs: @inject ISnackbar Snackbar
            }
        }
    public void BtnBack()
        {
        //Navman.NavigateTo ("/T_Students");
        Navman.NavigateTo (appState.ReturnPage?? "/Login");
        }
    //methods
    public async Task ReadPageDataLists()
        {
        int id = Convert.ToInt32 (Id);        
        switch (mode)
            {
            case "G":
                    {
                    appState.SetReturnPage ($"/T_Students");
                    var result = await feService.Read_StudentsByGCEMId (id, "G", 15);
                    lstStudents = result;
                    break;
                    }
            case "C":
                    {
                    appState.SetReturnPage ($"/T_Students");
                    lstStudents = await feService.Read_StudentsByGCEMId (id, "C", 15);
                    break;
                    }
            case "E":
                    {
                    appState.SetReturnPage ($"/T_Exams");
                    lstStudents = await feService.Read_StudentsByGCEMId (id, "E", 15);
                    break;
                    }
            case "M":
                    {
                    appState.SetReturnPage ($"/T_Students");
                    lstStudents = await feService.Read_StudentsByGCEMId (id, "M", 15);
                    break;
                    }
            case "S":
                    {
                    appState.SetReturnPage ($"/T_Students");
                    lstStudents = await feService.Read_StudentsByGCEMId (id, "S", 15);
                    break;
                    }
            }
        }
}
