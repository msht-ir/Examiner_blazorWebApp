@page "/T_ReportExamPoints"
@using ExaminerB.Service
@using Microsoft.VisualBasic
@inject FeService feService
@inject NavigationManager Navman
@inject AppState appState
@inject IJSRuntime JS
@implements IDisposable
@inject ISnackbar Snackbar

@if (!_hasFetched)
    {
    <_ScanSheets />
    }
else
    {
    //Page-Header
    <div style="text-align:center; padding:10px;">
        <h6>Students Exam Points</h6>
        <h3>Exam: @exam.ExamTitle</h3>
        <h6 style="color:indianred">course: @course.CourseName</h6>
    </div>
    <EditForm Model = "lstStudentsExam">
        <hr />
        @{
            i = 0;
        }
        @foreach (var studentExam in lstStudentsExam) 
            {
            i++;
                <div class="container mt-2">
                    <div class="card">
                        <div class="card-body" style="background-color:whitesmoke">
                            <div style="font-weight:bold;">
                                @i: @studentExam.StudentName - @studentExam.StudentNickname
                                <hr />
                            </div>
                            <div style="font-weight:normal;">
                                <img src="/img/icoReport0.png" width="20" />
                                <span style="color:green">Start : </span> @studentExam.StartDateTime <br />
                                <img src="/img/icoClock2.png" width="18" />
                                <span style="color:royalblue">Finish: </span> @studentExam.FinishDateTime
                            </div>
                            <div style="display:flex; align-items:center;font-weight:bold;">
                                <button class="btn btn-link" @onclick="async ()=> await BtnShowStudentExamTests(studentExam)">
                                    <img src="/img/icoListT.png" width="24" />
                                </button>
                                @if(studentExam.StudentExamPoint < 10)
                                    {
                                    <span style="color:red">@(Math.Abs(studentExam.StudentExamPoint).ToString("F2"))</span> <span style="font-size:x-small;color:dimgray"> /20</span>
                                    }
                                else if (studentExam.StudentExamPoint < 17)
                                    {
                                    <span style="color:royalblue">@(Math.Abs(studentExam.StudentExamPoint).ToString("F2"))</span> <span style="font-size:x-small;color:dimgray"> /20</span>
                                    }
                                else 
                                    {
                                    <span style="color:darkgoldenrod">@(Math.Abs(studentExam.StudentExamPoint).ToString("F2"))</span> <span style="font-size:x-small;color:dimgray"> /20</span>
                                    }
                                </div>
                        </div>
                    </div>
                </div>
            }
            <div style="text-align: center;">
                <button class="btn btn-link" type="submit" @onclick="BtnBack">
                    <img src="/img/icoBack.png" width="30" />
                </button>
            </div>
    </EditForm>
    }
    <script>
        window.scrollToTop = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }; 
    </script>

@code {
    public bool _hasFetched = false;
    public List<User> lstStudents = new List<User> ();
    List<StudentExam> lstStudentsExam = new List<StudentExam> ();
    User user = new User ();
    Course course = new Course ();
    Exam exam = new Exam ();
    int i = 0;
    public int nStudents = 0;
    public int nStudentsStarted = 0;
    public int nStudentsFinished = 0;
    public int TotalPoints = 0;

    //LifeCycleEvents
    protected override async Task OnInitializedAsync()
        {
        appState.OnChange += TriggerRender;
        if(Convert.ToInt32(appState.UserLoginStatus) != 1)
            {
            Navman.NavigateTo ("/Login");
            }
        await RefreshPageData ();
        _hasFetched = true;
        } 
    private void TriggerRender()
        {
        InvokeAsync(StateHasChanged);
        }
    public void Dispose()
        {
        appState.OnChange -= TriggerRender;
        }
    //btns
    public void BtnShowAnswers()
        {
        string _appstatecmd = appState.Cmd ?? "";
        _appstatecmd = (_appstatecmd.EndsWith ("raw")) ? (Strings.Left (_appstatecmd, _appstatecmd.Length - 3)) : (_appstatecmd + "raw");
        appState.SetCmd (_appstatecmd);
        i = 0;
        }
    public async Task BtnShowCourseTestStats(StudentExamTest studentExamTest)
        {
        _hasFetched = false;
        //Read StudentExam and StudentExamTest Across Students
        List<StudentExamTest> lstStudentsExamTest = await feService.Read_StudentsExamTest (studentExamTest);
        //calcs ...
        nStudents = lstStudentsExamTest.Count;
        // nStudentsVisited = 0;
        // nStudentsAnswered = 0;
        // nStudentsAnsweredCorrectly = 0;
        // nStudentsAnsweredIncorrectly = 0;
        // nStudentsNotAnswered = 0;
        // nStudentsSlectedOpt1 = 0;
        // nStudentsSlectedOpt2 = 0;
        // nStudentsSlectedOpt3 = 0;
        // nStudentsSlectedOpt4 = 0;
        // nStudentsSlectedOpt5 = 0;
        // foreach(StudentExamTest tst in lstStudentsExamTest)
        //     {
        //     if((tst.StudentExamTestTags & 1) == 1)
        //         {
        //         nStudentsVisited++;
        //         }
        //     if((tst.StudentExamTestTags & 4) == 4)
        //         {
        //         nStudentsAnswered++;
        //         if(tst.StudentExamTestAns == tst.StudentExamTestKey)
        //             {
        //             nStudentsAnsweredCorrectly++;
        //             }
        //         else
        //             {
        //             nStudentsAnsweredIncorrectly++;                    
        //             }
        //         }
        //     if((tst.StudentExamTestAns == studentExamTest.Opt1Id))
        //         {
        //         nStudentsSlectedOpt1++;
        //         }
        //     if((tst.StudentExamTestAns == studentExamTest.Opt2Id))
        //         {
        //         nStudentsSlectedOpt2++;
        //         }
        //     if((tst.StudentExamTestAns == studentExamTest.Opt3Id))
        //         {
        //         nStudentsSlectedOpt3++;
        //         }
        //     if((tst.StudentExamTestAns == studentExamTest.Opt4Id))
        //         {
        //         nStudentsSlectedOpt4++;
        //         }
        //     if((tst.StudentExamTestAns != 0) & (tst.StudentExamTestAns == studentExamTest.Opt5Id))
        //         {
        //         nStudentsSlectedOpt5++;
        //         }
        //     }
        // nStudentsNotAnswered = nStudentsVisited - nStudentsAnswered;
        if (appState.TestId == studentExamTest.TestId)
            {
            appState.SetTestId (0);
            }
        else
            {
            appState.SetTestId (studentExamTest.TestId);
            }
        //appState.SetCmd ("ShowStudentExamTestStats");
        _hasFetched = true;
        StateHasChanged ();
        }
    public async Task BtnShowStudentExamTests(StudentExam studentExam)
        {
        appState.SetCmd ("studentexamtests"); //{studentexamtests|studentcoursetests}
        appState.SetStudentExamId (studentExam.StudentExamId);
        appState.SetStudentName (studentExam.StudentName);
        appState.SetStudentNickname (studentExam.StudentNickname);
        Navman.NavigateTo ("/T_ReportTests");
        }
    public void BtnBack()
        {
        if (appState.ReturnPage != "/T_ReportTests")
            {
            Navman.NavigateTo (appState.ReturnPage?? "/Login");
            }
        else
            {
            Navman.NavigateTo ("/T_Courses");
            }
        }
    //method
    public async Task RefreshPageData()
        {
        exam.ExamId = Convert.ToInt32 (appState.ExamId);
        _hasFetched = false;
        exam = await feService.Read_Exam (exam.ExamId, true);
        //
        lstStudentsExam.Clear ();
        lstStudentsExam = await feService.Read_StudentsExam (Convert.ToInt32 (appState.ExamId));
        if (lstStudentsExam.Count > 0)
            {
            exam.ExamDateTime = lstStudentsExam[0].ExamDateTime;
            exam.ExamTitle = lstStudentsExam[0].ExamTitle;
            exam.ExamDuration = lstStudentsExam[0].ExamDuration;
            course.CourseName = lstStudentsExam[0].CourseName;            
            }
        else
            {
            //needs: @inject ISnackbar Snackbar --at top of page
            Snackbar.Add("List of Students (for this Exam) is Empty!", Severity.Warning); //Severity.Error | Severity.Info | Severity.Success
            //--old code was: await JS.InvokeVoidAsync ("alert", "List of Students (for this Exam) is Empty!");
            BtnBack ();
            }
        _hasFetched = true;
        }
}
